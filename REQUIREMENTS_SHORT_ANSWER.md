# 短答式試験実施機能 要件定義書

## 1. 概要

短答式試験の問題を解く機能を提供する。ユーザーは問題を選択して解答し、正誤を確認できる。

## 2. データ構造

### 2.1 JSONファイル構造

各試験の年度・科目ごとにJSONファイルを作成する。

**ファイル名**: `{年度}_{試験種別}_短答_{科目}.json`

**例**: `R7_予備_短答_憲法・行政法.json`

**JSON構造**:
```json
{
  "year": "R7",
  "exam_type": "予備",
  "subject": "憲法・行政法",
  "source_pdf": "問題文元pdf/予備試験/R7/R7_予備_短答_憲法・行政法.pdf",
  "problems": [
    {
      "question_number": 1,
      "question_text": "問題本文",
      "choice_1": "選択肢1のテキスト",
      "choice_2": "選択肢2のテキスト",
      "choice_3": "選択肢3のテキスト",
      "choice_4": "選択肢4のテキスト",
      "correct_answer": "1",
      "correctness_pattern": "〇☓☓☓"
    }
  ]
}
```

**注意事項**:
- `correct_answer`: 正解の選択肢番号（"1", "2", "3", "4"など）。複数選択可の場合は"1,2"のようにカンマ区切り
- `correctness_pattern`: 各選択肢の正誤を表す（"〇"=正しい、"☓"=誤り）。選択肢1,2,3,4の順
- 3択問題の場合は`choice_4`をNULLまたは空文字にする

### 2.2 データベースモデル（新規追加）

**ShortAnswerProblem** テーブル:
- `id`: 主キー
- `exam_type`: 試験種別（"司法試験" or "予備試験"）
- `year`: 年度（整数、例: 2025）
- `subject`: 科目
- `question_number`: 問題番号（同一科目内での連番）
- `question_text`: 問題本文
- `choice_1`: 選択肢1のテキスト
- `choice_2`: 選択肢2のテキスト
- `choice_3`: 選択肢3のテキスト
- `choice_4`: 選択肢4のテキスト（NULL可、3択問題の場合）
- `correct_answer`: 正解の選択肢番号（"1", "2", "3", "4"など、複数選択可の場合は"1,2"など）
- `correctness_pattern`: 正誤パターン（"〇〇☓☓"など、各選択肢の正誤を表す）
- `source_pdf`: PDFファイルのパス
- `created_at`, `updated_at`: タイムスタンプ

**ShortAnswerSession** テーブル（解答セッション管理）:
- `id`: 主キー
- `user_id`: ユーザーID（将来的に拡張、現時点ではNULL可）
- `exam_type`: 試験種別（フィルター条件）
- `year`: 年度（フィルター条件、NULL可）
- `subject`: 科目（フィルター条件）
- `is_random`: ランダムモードかどうか
- `problem_ids`: 出題された問題IDのリスト（JSON配列）
- `started_at`: 開始時刻
- `completed_at`: 完了時刻（NULL可）

**ShortAnswerAnswer** テーブル（解答記録）:
- `id`: 主キー
- `session_id`: セッションID（外部キー）
- `problem_id`: 問題ID（外部キー）
- `selected_answer`: 選択した選択肢番号（"1", "2", "3", "4"など、複数選択可の場合は"1,2"など）
- `is_correct`: 正誤（boolean）
- `answered_at`: 解答時刻

## 3. 機能要件

### 3.1 問題選択画面

**表示項目**:
- 試験種別選択（ドロップダウン）: ["", "司法試験", "予備試験"]
- 年度選択（ドロップダウン）: 利用可能な年度一覧（R7, H30など）
- 科目選択（ドロップダウン）: 利用可能な科目一覧
- ランダムモードチェックボックス: 「科目のみ指定して全試験・年度からランダム出題」
- 「開始」ボタン

**動作**:
- 試験種別、年度、科目を指定した場合: 該当する問題セットを取得
- ランダムモードがONの場合: 科目のみ指定し、全試験種別・全年度からランダムに問題を選択
- 「開始」ボタンで解答セッションを開始

### 3.2 問題表示画面

**表示項目**:
- **右上**: 試験種別、年度、第何問の表記（例：「予備R7第5問」）
- **中央上部**: 進捗表示（例：「2/20問」）
- **問題文エリア**: 問題本文を表示
- **選択肢エリア**: 
  - 各選択肢をボタンまたはラジオボタンで表示
  - ワンクリックで選択可能
  - 選択中の選択肢は視覚的に強調
- **「回答を見る」ボタン**: 回答画面に遷移
- **「戻る」ボタン**: 前の問題に戻る（最初の問題の場合は無効化）
- **「次へ」ボタン**: 次の問題に進む（最後の問題の場合は「終了」に変更）

**状態管理**:
- セッション情報をStreamlitのsession_stateで管理
- 選択した選択肢を一時保存（回答を見るまで確定しない）

### 3.3 回答表示画面

**表示項目**:
- **上部**: 大きく正誤を表示
  - 正解の場合: 「正解」を大きく緑色で表示
  - 不正解の場合: 「不正解」を大きく赤色で表示
- **選択肢エリア**: 
  - 各選択肢の左側に〇or☓を表示
  - 正解の選択肢: 〇（緑色）
  - 誤りの選択肢: ☓（赤色）
  - ユーザーが選択した選択肢: 背景色で強調
- **解説エリア**（任意）: 各選択肢の解説を表示
- **「戻る」ボタン**: 問題表示画面に戻る
- **「次へ」ボタン**: 次の問題に進む（最後の問題の場合は「終了」に変更）

**動作**:
- 回答画面で解答を確定し、データベースに保存
- 正誤を判定して表示

### 3.4 ナビゲーション

**同一セッション内での移動**:
- 前の問題に戻ることができる
- 既に回答済みの問題は、選択した選択肢と正誤が表示される
- 回答済みの問題でも選択肢を変更可能（上書き保存）

**進捗表示**:
- 常に「現在の問題番号/全問題数」を表示（例：「2/20問」）

## 4. 技術仕様

### 4.1 フロントエンド（Streamlit）

**ページ構成**:
- メインページに「短答式試験」タブを追加
- 問題選択画面 → 問題表示画面 → 回答表示画面の流れ

**状態管理**:
- `st.session_state`を使用して以下を管理:
  - `short_answer_session_id`: セッションID
  - `short_answer_current_index`: 現在の問題インデックス
  - `short_answer_answers`: 解答の辞書（問題ID → 選択肢番号）
  - `short_answer_show_answer`: 回答表示フラグ

### 4.2 バックエンド（FastAPI）

**新規エンドポイント**:
- `GET /v1/short-answer/problems`: 問題一覧取得（フィルター対応）
- `POST /v1/short-answer/sessions`: セッション開始
- `GET /v1/short-answer/sessions/{session_id}`: セッション情報取得
- `POST /v1/short-answer/answers`: 解答送信
- `GET /v1/short-answer/sessions/{session_id}/answers`: セッション内の解答一覧取得

## 5. 実装順序

1. **データ構造の定義**
   - データベースモデルの追加（ShortAnswerProblem, ShortAnswerChoice, ShortAnswerSession, ShortAnswerAnswer）
   - JSONスキーマの定義

2. **データインポート機能**
   - 短答式PDFからJSONへの変換スクリプト
   - JSONからデータベースへのインポートスクリプト

3. **バックエンドAPI**
   - 新規エンドポイントの実装

4. **フロントエンドUI**
   - 問題選択画面
   - 問題表示画面
   - 回答表示画面

5. **ナビゲーション機能**
   - 前後移動機能
   - 進捗表示

## 6. 将来の拡張

- 解答履歴の保存・閲覧
- 統計情報の表示（正答率、苦手分野など）
- タイマー機能
- 模試モード（制限時間あり）
