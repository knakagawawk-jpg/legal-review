# 開発環境用Caddyfile（単独起動時用）
# - Domain is configured via CADDY_DOMAIN_DEV (default: dev.localhost)
# - Basic auth uses BASIC_AUTH_USER_DEV / BASIC_AUTH_PASS_HASH_DEV (bcrypt hash)
#
# 動作説明:
# - localhostの場合: ポートベース（:80）でHTTPのみ（環境変数を切り替える必要はありません）
# - サーバー上の場合: ドメインベースで自動TLS（環境変数CADDY_DOMAIN_DEVを変更）
#   ※ proxy-dev は 80/443 でリッスン。Let's Encrypt が 80 番を使うため、応答遅延を防ぎます。
# Caddyは自動的に適切な設定を選択します。

# ポートベースの設定（localhost用、HTTPのみ）
# この設定は常に有効で、localhostでアクセスする際に使用されます
# 環境変数を切り替える必要はありません
:80 {
    # HTTPのみ（TLS無効化）
    
    # Basic auth（サーバー用）。ローカルで認証なしにする場合は .env.dev で CADDYFILE_DEV_PATH=./Caddyfile.dev.local を指定
    @not_api {
        not path /api/* /_next/* /favicon.ico
    }
    basic_auth @not_api {
        {$BASIC_AUTH_USER_DEV} {$BASIC_AUTH_PASS_HASH_DEV}
    }

    # セキュリティヘッダー
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # リバースプロキシのタイムアウトを10分に設定（講評生成処理に時間がかかるため）
    reverse_proxy web-dev-server:3000 {
        transport http {
            dial_timeout 10s
            response_header_timeout 600s  # 10分（レスポンスヘッダーの待機時間）
            read_timeout 600s  # 10分（レスポンスボディの読み込みタイムアウト）
            write_timeout 600s  # 10分（リクエストボディの書き込みタイムアウト）
        }
    }
}

# ドメインベースの設定（サーバー上で使用、dev.juristutor-ai.comなど）
# CADDY_DOMAIN_DEV=dev.juristutor-ai.com のとき、このブロックが有効になり
# Let's Encrypt で自動TLS（HTTPS）が有効になります。
# アクセス: https://dev.juristutor-ai.com（ポート指定不要）。
# localhostの場合は上記の:80ブロックが使用されます。
{$CADDY_DOMAIN_DEV:dev.localhost} {
    # 自動TLS（Let's Encrypt）で HTTPS を提供

    # Basic auth（サーバー用）
    @not_api {
        not path /api/* /_next/* /favicon.ico
    }
    basic_auth @not_api {
        {$BASIC_AUTH_USER_DEV} {$BASIC_AUTH_PASS_HASH_DEV}
    }

    # セキュリティヘッダー
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # リバースプロキシのタイムアウトを10分に設定（講評生成処理に時間がかかるため）
    reverse_proxy web-dev-server:3000 {
        transport http {
            dial_timeout 10s
            response_header_timeout 600s  # 10分（レスポンスヘッダーの待機時間）
            read_timeout 600s  # 10分（レスポンスボディの読み込みタイムアウト）
            write_timeout 600s  # 10分（リクエストボディの書き込みタイムアウト）
        }
    }
}
