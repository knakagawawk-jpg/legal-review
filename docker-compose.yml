version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: app/Dockerfile
    container_name: law-review-backend
    env_file:
      - .env
    environment:
      - DATABASE_URL=${DATABASE_URL:-sqlite:////data/dev.db}
      # 注意: モデル名はユーザーが明示的に指定したものです。AIが勝手に変更しないでください。
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-haiku-4-5-20251001}
      # 用途別のモデル設定（オプション、未設定の場合はANTHROPIC_MODELが使用されます）
      - ANTHROPIC_MODEL_REVIEW=${ANTHROPIC_MODEL_REVIEW:-}
      - ANTHROPIC_MODEL_REVIEW_CHAT=${ANTHROPIC_MODEL_REVIEW_CHAT:-}
      - ANTHROPIC_MODEL_FREE_CHAT=${ANTHROPIC_MODEL_FREE_CHAT:-}
      - ANTHROPIC_MODEL_REVISIT_PROBLEMS=${ANTHROPIC_MODEL_REVISIT_PROBLEMS:-}
      - ANTHROPIC_MODEL_TITLE=${ANTHROPIC_MODEL_TITLE:-}
      - AUTH_ENABLED=${AUTH_ENABLED:-false}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
    volumes:
      - ./data:/data
      # backend で .env を直接読めるようにマウント（キーはenvファイルにのみ保持）
      - ./.env:/app/.env:ro
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    # ports公開しない（内部ネットワークのみアクセス可能）

  # Next.js（フロントエンド）- 本番用
  web:
    build:
      context: .
      dockerfile: Dockerfile.nextjs
      args:
        NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
        BACKEND_INTERNAL_URL: ${BACKEND_INTERNAL_URL:-http://backend:8000}
    container_name: law-review-web
    environment:
      - BACKEND_INTERNAL_URL=${BACKEND_INTERNAL_URL:-http://backend:8000}
      - NEXT_PUBLIC_GOOGLE_CLIENT_ID=${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
      # 講評生成のタイムアウト（デフォルト: 10分 = 600000ms）
      # 注意: この値はユーザーが明示的に指定したものです。AIが勝手に変更しないでください。
      - REVIEW_TIMEOUT_MS=${REVIEW_TIMEOUT_MS:-600000}
      - NODE_ENV=production
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - production  # 本番環境用プロファイル
    # ports公開しない（proxy経由のみアクセス可能）

  # Next.js（フロントエンド）- 開発用（ホットリロード対応）
  web-dev:
    build:
      context: .
      dockerfile: Dockerfile.nextjs.dev
    container_name: law-review-web-dev
    environment:
      - BACKEND_INTERNAL_URL=${BACKEND_INTERNAL_URL:-http://backend:8000}
      - NEXT_PUBLIC_GOOGLE_CLIENT_ID=${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
      - REVIEW_TIMEOUT_MS=${REVIEW_TIMEOUT_MS:-600000}
      - NODE_ENV=development
      - WATCHPACK_POLLING=true  # ファイル変更検知のため
    volumes:
      # ソースコードをマウント（ホットリロード対応）
      - ./web_next:/app
      - /app/node_modules  # node_modulesはボリュームで上書きしない
      - /app/.next  # .nextもボリュームで上書きしない
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - local  # ローカル開発用プロファイル
    # ports公開しない（proxy経由のみアクセス可能）

  proxy:
    env_file:
      - .env
    image: caddy:2-alpine
    container_name: law-review-proxy
    profiles:
      - production  # 本番環境用プロファイル（ドメインでアクセス）
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3用
    volumes:
      # 本番環境用Caddyfileを使用（環境変数 CADDYFILE_PATH で切り替え可能、デフォルト: Caddyfile.production）
      - ${CADDYFILE_PATH:-./Caddyfile.production}:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      web:
        condition: service_healthy
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:2019/config/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  proxy-local:
    image: caddy:2-alpine
    container_name: law-review-proxy-local
    profiles:
      - local  # ローカル開発用プロファイル
    ports:
      - "8080:80"  # ローカル開発用（権限不要、競合回避）
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      web-dev:
        condition: service_healthy
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "--timeout=5", "http://localhost/"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 20s

volumes:
  # Caddyの証明書と設定を永続化（HTTPS証明書を保持）
  # 名前付きボリュームとして管理（Dockerが管理する場所に保存）
  caddy_data:
    driver: local
  caddy_config:
    driver: local

networks:
  law-review-network:
    driver: bridge
