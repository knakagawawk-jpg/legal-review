services:
  # バックエンド - 本番環境用
  backend:
    build:
      context: .
      dockerfile: app/Dockerfile
    container_name: law-review-backend
    env_file:
      - .env
    # 注意: 環境変数は env_file (.env) から読み込まれます
    # environment セクションで同じ変数を設定すると env_file の値を上書きしてしまうため、
    # ここでは設定しません
    volumes:
      # サーバーで別ディレクトリから起動する場合は LAW_REVIEW_DATA_DIR=/opt/law-review/data などで絶対パス指定
      - ${LAW_REVIEW_DATA_DIR:-./data}:/data
      # backend で .env を直接読めるようにマウント（キーはenvファイルにのみ保持）
      - ./.env:/app/.env:ro
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    profiles:
      - production # 本番環境用プロファイル
    # ports公開しない（内部ネットワークのみアクセス可能）

    # バックエンド - βテスト環境用
  backend-beta:
    build:
      context: .
      dockerfile: app/Dockerfile
    container_name: law-review-backend-beta
    env_file:
      - .env.beta
    # 注意: 環境変数は env_file (.env.beta) から読み込まれます
    # environment セクションで同じ変数を設定すると env_file の値を上書きしてしまうため、
    # ここでは設定しません
    volumes:
      - ${LAW_REVIEW_DATA_DIR:-./data}:/data
      - ./.env.beta:/app/.env:ro
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    profiles:
      - beta # βテスト環境用プロファイル
    # ports公開しない（内部ネットワークのみアクセス可能）

    # バックエンド - 開発環境用
  backend-dev:
    build:
      context: .
      dockerfile: app/Dockerfile
    container_name: law-review-backend-dev
    env_file:
      - ${DEV_ENV_FILE:-.env.dev}
    # 注意: 環境変数は env_file から読み込み。DEV_ENV_FILE で .env.dev1（ローカル）/.env.dev2（サーバー）を切り替え
    # environment セクションで同じ変数を設定すると env_file の値を上書きしてしまうため、
    # ここでは設定しません
    volumes:
      - ${LAW_REVIEW_DATA_DIR:-./data}:/data
      - ./${DEV_ENV_FILE:-.env.dev}:/app/.env:ro
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    profiles:
      - dev # 開発環境用プロファイル
    # ports公開しない（内部ネットワークのみアクセス可能）

    # Next.js（フロントエンド）- 本番用
  web:
    build:
      context: .
      dockerfile: Dockerfile.nextjs
      args:
        NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
        BACKEND_INTERNAL_URL: ${BACKEND_INTERNAL_URL:-http://backend:8000}
    container_name: law-review-web
    environment:
      - BACKEND_INTERNAL_URL=${BACKEND_INTERNAL_URL:-http://backend:8000}
      - NEXT_PUBLIC_GOOGLE_CLIENT_ID=${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
      # 講評生成のタイムアウト（デフォルト: 10分 = 600000ms）
      # 注意: この値はユーザーが明示的に指定したものです。AIが勝手に変更しないでください。
      - REVIEW_TIMEOUT_MS=${REVIEW_TIMEOUT_MS:-600000}
      - NODE_ENV=production
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - production # 本番環境用プロファイル
    # ports公開しない（proxy経由のみアクセス可能）

    # Next.js（フロントエンド）- βテスト環境用
  web-beta:
    build:
      context: .
      dockerfile: Dockerfile.nextjs
      args:
        NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
        BACKEND_INTERNAL_URL: http://backend-beta:8000
    container_name: law-review-web-beta
    env_file:
      - .env.beta
    environment:
      # BACKEND_INTERNAL_URLはβ環境固定（env_fileのBACKEND_INTERNAL_URL_BETAとは別）
      - BACKEND_INTERNAL_URL=http://backend-beta:8000
      - NODE_ENV=production
    # 注意: NEXT_PUBLIC_GOOGLE_CLIENT_ID, REVIEW_TIMEOUT_MS は env_file (.env.beta) から読み込まれます
    depends_on:
      backend-beta:
        condition: service_healthy
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - beta # βテスト環境用プロファイル
    # ports公開しない（proxy経由のみアクセス可能）

    # Next.js（フロントエンド）- 開発用（ホットリロード対応、ローカル用）
  web-dev:
    build:
      context: .
      dockerfile: Dockerfile.nextjs.dev
    container_name: law-review-web-dev
    environment:
      - BACKEND_INTERNAL_URL=${BACKEND_INTERNAL_URL:-http://backend:8000}
      - NEXT_PUBLIC_GOOGLE_CLIENT_ID=${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
      - REVIEW_TIMEOUT_MS=${REVIEW_TIMEOUT_MS:-600000}
      - NODE_ENV=development
      - WATCHPACK_POLLING=true # ファイル変更検知のため
    volumes:
      # ソースコードをマウント（ホットリロード対応）
      - ./web_next:/app
      - /app/node_modules # node_modulesはボリュームで上書きしない
      - /app/.next # .nextもボリュームで上書きしない
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - local # ローカル開発用プロファイル
    # ports公開しない（proxy経由のみアクセス可能）

    # Next.js（フロントエンド）- 開発用（ホットリロード対応、サーバー上）
  web-dev-server:
    build:
      context: .
      dockerfile: Dockerfile.nextjs.dev
    container_name: law-review-web-dev-server
    env_file:
      - ${DEV_ENV_FILE:-.env.dev}
    environment:
      # BACKEND_INTERNAL_URLは開発環境固定
      - BACKEND_INTERNAL_URL=http://backend-dev:8000
      - NODE_ENV=development
      - WATCHPACK_POLLING=true # ファイル変更検知のため
      - ENABLE_DEV_PAGE=true # 開発者用ページを有効化（dev環境のみ）
      - NEXT_PUBLIC_ENABLE_DEV_PAGE=true # フロントエンド用（dev環境のみ）
    # 注意: NEXT_PUBLIC_GOOGLE_CLIENT_ID, REVIEW_TIMEOUT_MS は env_file から読み込まれます
    volumes:
      # ソースコードをマウント（ホットリロード対応）
      - ./web_next:/app
      - /app/node_modules # node_modulesはボリュームで上書きしない
      - /app/.next # .nextもボリュームで上書きしない
    depends_on:
      backend-dev:
        condition: service_healthy
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - dev # 開発環境用プロファイル（サーバー上）
    # ローカル開発用: proxy で接続できない場合に http://localhost:3000 で直接アクセス可能
    ports:
      - "3000:3000"

    # プロキシ - 本番環境用（複数ドメイン対応）
  proxy:
    env_file:
      - .env
    environment:
      # Caddyfileで使用する環境変数を明示的に渡す
      - CADDY_DOMAIN=${CADDY_DOMAIN:-localhost}
      - CADDY_DOMAIN_BETA=${CADDY_DOMAIN_BETA:-beta.localhost}
      - CADDY_DOMAIN_DEV=${CADDY_DOMAIN_DEV:-dev.localhost}
      - BASIC_AUTH_USER=${BASIC_AUTH_USER:-}
      - BASIC_AUTH_USER_BETA=${BASIC_AUTH_USER_BETA:-}
      - BASIC_AUTH_USER_DEV=${BASIC_AUTH_USER_DEV:-}
      # BASIC_AUTH_PASS_HASHはenv_fileから読み込まれる
      # 注意: .envファイルでは$$でエスケープする必要がある（$$2a$$14$$...）
      # ハッシュ生成: docker run --rm caddy:2-alpine caddy hash-password --plaintext your-password
    image: caddy:2-alpine
    container_name: law-review-proxy
    profiles:
      - production # 本番環境用プロファイル（ドメインでアクセス）
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp" # HTTP/3用
    volumes:
      # 複数ドメイン対応のCaddyfileを使用
      - ${CADDYFILE_PATH:-./Caddyfile.production}:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      web:
        condition: service_healthy
      # 注意: web-betaとweb-dev-serverへの依存関係は削除
      # これらはbeta/devプロファイルで起動されるため、productionプロファイルのみで起動する場合は存在しない
      # 複数環境を同時に起動する場合は、--profile production --profile beta --profile dev を使用
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:2019/config/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # プロキシ - βテスト環境用（単独起動時用、通常はproxyと統合）
  proxy-beta:
    env_file:
      - .env.beta
    # 注意: CADDY_DOMAIN_BETA, BASIC_AUTH_USER_BETA, BASIC_AUTH_PASS_HASH_BETA は
    # env_file (.env.beta) から読み込まれます
    image: caddy:2-alpine
    container_name: law-review-proxy-beta
    profiles:
      - beta # βテスト環境用プロファイル（単独起動時）
    ports:
      - "8080:80"
      - "8443:443"
      - "8443:443/udp"
    volumes:
      - ./Caddyfile.beta:/etc/caddy/Caddyfile:ro
      - caddy_data_beta:/data
      - caddy_config_beta:/config
    depends_on:
      web-beta:
        condition: service_healthy
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "--timeout=5", "http://localhost/" ]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 20s

  # プロキシ - 開発環境用（単独起動時用、通常はproxyと統合）
  # 本番 proxy が 80/443 を使う場合は、dev は本番 proxy 経由でアクセスすること。
  # 単独起動時のみ 8081/8444 を使用（本番と同時起動時は proxy-dev のポートは使わない）。
  proxy-dev:
    env_file:
      - ${DEV_ENV_FILE:-.env.dev}
    # 注意: CADDY_DOMAIN_DEV, BASIC_AUTH_USER_DEV, BASIC_AUTH_PASS_HASH_DEV は
    # env_file（DEV_ENV_FILE で .env.dev1 / .env.dev2 を指定）から読み込まれます
    image: caddy:2-alpine
    container_name: law-review-proxy-dev
    profiles:
      - dev # 開発環境用プロファイル（単独起動時）
    ports:
      # Windows で 127.0.0.1 だと接続拒否になる場合があるため 8081:80 で全インターフェースにバインド
      - "8081:80"
      - "8444:443"
      - "8444:443/udp"
    volumes:
      # ローカル: .env.dev1 で CADDYFILE_DEV_PATH=./Caddyfile.dev.local を設定。サーバー: .env.dev2 では未設定
      - ${CADDYFILE_DEV_PATH:-./Caddyfile.dev}:/etc/caddy/Caddyfile:ro
      - caddy_data_dev:/data
      - caddy_config_dev:/config
    depends_on:
      web-dev-server:
        condition: service_healthy
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "--timeout=5", "http://localhost/" ]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 20s

  proxy-local:
    image: caddy:2-alpine
    container_name: law-review-proxy-local
    profiles:
      - local # ローカル開発用プロファイル
    ports:
      - "8080:80" # ローカル開発用（権限不要、競合回避）
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      web-dev:
        condition: service_healthy
    networks:
      - law-review-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "--timeout=5", "http://localhost/" ]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 20s

volumes:
  # Caddyの証明書と設定を永続化（HTTPS証明書を保持）
  # 名前付きボリュームとして管理（Dockerが管理する場所に保存）
  caddy_data:
    driver: local
  caddy_config:
    driver: local
  # βテスト環境用（単独起動時）
  caddy_data_beta:
    driver: local
  caddy_config_beta:
    driver: local
  # 開発環境用（単独起動時）
  caddy_data_dev:
    driver: local
  caddy_config_dev:
    driver: local

networks:
  law-review-network:
    driver: bridge
