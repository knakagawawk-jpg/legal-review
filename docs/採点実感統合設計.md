# 採点実感統合設計（OfficialQuestionへの統合）

## 設計変更の概要

### 現在の設計
- `OfficialQuestion`テーブル: 問題文、出題趣旨を管理
- `ShihouGradingImpression`テーブル: 司法試験の採点実感を別テーブルで管理（1対1）

### 変更後の設計
- `OfficialQuestion`テーブルに`grading_impression_text`カラムを追加（NULL可）
- 予備試験: `grading_impression_text = NULL`
- 司法試験: `grading_impression_text = 採点実感の本文`（NULL可、存在しない場合もある）

## メリット

1. **JOINが不要になる**
   - 現在: `official_q.grading_impression.grading_impression_text`
   - 変更後: `official_q.grading_impression_text`

2. **テーブルが1つ減る**
   - `shihou_grading_impressions`テーブルが不要

3. **クエリが簡単になる**
   - LEFT JOINが不要
   - 単純なSELECTで取得可能

4. **バージョン管理が統一される**
   - 問題文と採点実感が同じテーブルで管理される
   - バージョンアップ時に一緒に管理できる

5. **コードがシンプルになる**
   - リレーションシップの管理が不要
   - NULLチェックのみで済む

## 修正が必要な箇所

### 1. モデル定義（`app/models.py`）

#### 変更前
```python
class OfficialQuestion(Base):
    # ...
    syutudaisyusi = Column(Text, nullable=True)  # 出題趣旨
    # ...
    grading_impression = relationship(
        "ShihouGradingImpression",
        back_populates="question",
        uselist=False,
        cascade="all, delete-orphan"
    )

class ShihouGradingImpression(Base):
    __tablename__ = "shihou_grading_impressions"
    question_id = Column(...)
    grading_impression_text = Column(Text, nullable=False)
```

#### 変更後
```python
class OfficialQuestion(Base):
    # ...
    syutudaisyusi = Column(Text, nullable=True)  # 出題趣旨
    grading_impression_text = Column(Text, nullable=True)  # 採点実感（司法試験のみ、NULL可）
    # ...
    # grading_impressionリレーションシップを削除

# ShihouGradingImpressionクラスを削除
```

### 2. メインAPI（`app/main.py`）

#### 変更箇所1: `_get_review_chat_context_by_review_id()`（322-323行目）
```python
# 変更前
if official_q.shiken_type == "shihou" and official_q.grading_impression:
    grading_impression_text = official_q.grading_impression.grading_impression_text or ""

# 変更後
if official_q.shiken_type == "shihou":
    grading_impression_text = official_q.grading_impression_text or ""
```

#### 変更箇所2: `/v1/official-questions/active`（437-443行目、453-454行目）
```python
# 変更前（437-443行目）
if shiken_type == "shihou" and detail.scoring_notes:
    db.add(
        ShihouGradingImpression(
            question_id=oq.id,
            grading_impression_text=detail.scoring_notes,
        )
    )

# 変更後
# OfficialQuestion作成時にgrading_impression_textを設定
oq = OfficialQuestion(
    shiken_type=shiken_type,
    nendo=nendo,
    subject_id=subject_id,
    version=1,
    status="active",
    text=detail.question_text,
    syutudaisyusi=detail.purpose,
    grading_impression_text=detail.scoring_notes if shiken_type == "shihou" else None,
)

# 変更前（453-454行目）
grading_text = None
if oq.shiken_type == "shihou" and oq.grading_impression:
    grading_text = oq.grading_impression.grading_impression_text

# 変更後
grading_text = oq.grading_impression_text if oq.shiken_type == "shihou" else None
```

#### 変更箇所3: `/v1/reviews`（905-906行目）
```python
# 変更前
if official_q.shiken_type == "shihou" and official_q.grading_impression:
    grading_impression_text = official_q.grading_impression.grading_impression_text

# 変更後
if official_q.shiken_type == "shihou":
    grading_impression_text = official_q.grading_impression_text
```

#### 変更箇所4: `/v1/reviews/{review_id}`（1222-1223行目）
```python
# 変更前
if official_q.shiken_type == "shihou" and official_q.grading_impression:
    grading_impression_text = official_q.grading_impression.grading_impression_text

# 変更後
if official_q.shiken_type == "shihou":
    grading_impression_text = official_q.grading_impression_text
```

### 3. シードスクリプト（`app/seed_official_questions.py`）

#### 変更箇所（115-121行目）
```python
# 変更前
oq = OfficialQuestion(
    shiken_type=shiken_type,
    nendo=nendo,
    subject_id=int(subject_id),
    version=1,
    status="active",
    text=detail.question_text,
    syutudaisyusi=detail.purpose,
)
db.add(oq)
db.flush()

if shiken_type == "shihou" and detail.scoring_notes:
    db.add(
        ShihouGradingImpression(
            question_id=oq.id,
            grading_impression_text=detail.scoring_notes,
        )
    )

# 変更後
oq = OfficialQuestion(
    shiken_type=shiken_type,
    nendo=nendo,
    subject_id=int(subject_id),
    version=1,
    status="active",
    text=detail.question_text,
    syutudaisyusi=detail.purpose,
    grading_impression_text=detail.scoring_notes if shiken_type == "shihou" else None,
)
db.add(oq)
# ShihouGradingImpressionの追加処理を削除
```

### 4. JSONインポートスクリプト（`scripts/import_all_json_to_db.py`）

#### 変更内容
- このスクリプトは`ProblemMetadata`/`ProblemDetails`にインポートしている
- `OfficialQuestion`への統合時に修正が必要（別途対応）

### 5. スキーマ定義（`app/schemas.py`）

#### 変更内容
- `OfficialQuestionActiveResponse`の`grading_impression_text`フィールドはそのまま使用可能
- 変更不要（NULL可のまま）

### 6. データベースマイグレーション

#### マイグレーションSQL（PostgreSQL）
```sql
-- 1. OfficialQuestionテーブルにgrading_impression_textカラムを追加
ALTER TABLE official_questions 
ADD COLUMN grading_impression_text TEXT;

-- 2. 既存のShihouGradingImpressionデータを移行
UPDATE official_questions oq
SET grading_impression_text = sgi.grading_impression_text
FROM shihou_grading_impressions sgi
WHERE oq.id = sgi.question_id;

-- 3. shihou_grading_impressionsテーブルを削除
DROP TABLE shihou_grading_impressions;
```

#### マイグレーションSQL（SQLite）
```sql
-- 1. OfficialQuestionテーブルにgrading_impression_textカラムを追加
ALTER TABLE official_questions 
ADD COLUMN grading_impression_text TEXT;

-- 2. 既存のShihouGradingImpressionデータを移行
UPDATE official_questions
SET grading_impression_text = (
    SELECT grading_impression_text 
    FROM shihou_grading_impressions 
    WHERE shihou_grading_impressions.question_id = official_questions.id
)
WHERE EXISTS (
    SELECT 1 
    FROM shihou_grading_impressions 
    WHERE shihou_grading_impressions.question_id = official_questions.id
);

-- 3. shihou_grading_impressionsテーブルを削除
DROP TABLE shihou_grading_impressions;
```

## 実装手順

1. **モデル定義の修正**（`app/models.py`）
   - `OfficialQuestion`に`grading_impression_text`カラムを追加
   - `ShihouGradingImpression`クラスを削除
   - リレーションシップを削除

2. **コード修正**（`app/main.py`, `app/seed_official_questions.py`）
   - `official_q.grading_impression.grading_impression_text` → `official_q.grading_impression_text`に変更
   - `ShihouGradingImpression`の作成処理を削除

3. **データベースマイグレーション**
   - 既存データを移行
   - `shihou_grading_impressions`テーブルを削除

4. **テスト**
   - 司法試験の問題で採点実感が正しく取得できるか確認
   - 予備試験の問題でNULLが返ることを確認

## 注意事項

1. **既存データの移行**
   - マイグレーション前にバックアップを取得
   - 移行後、データの整合性を確認

2. **NULLチェック**
   - 司法試験でも採点実感が存在しない場合がある
   - `if official_q.grading_impression_text:` でNULLチェック

3. **バージョン管理**
   - バージョンアップ時も採点実感を含めて管理される
   - 旧バージョンの採点実感も保持される
