# 別環境で localhost 開発するためのセットアップ手順

GitHub から clone した別の PC で、localhost の開発環境（dev1）を動かすために必要な作業をまとめます。

---

## 1. 前提ソフトウェアのインストール

| 項目 | 内容 |
|------|------|
| **Docker Desktop** | 必須。`docker compose` でバックエンド・フロント・プロキシを起動するため。 [Docker Desktop for Windows](https://docs.docker.com/desktop/install/windows-install/) をインストールし、起動しておく。 |
| **Git** | clone に使用。多くの環境では既に入っている。 |
| **PowerShell** | 起動スクリプト `dev1-up.ps1` は PowerShell 用。Windows 標準の PowerShell で可。 |

**補足**: Node.js や Python は **ホストに直接インストール不要**。開発用の Next.js / FastAPI は Docker コンテナ内で動きます。

---

## 2. リポジトリの取得

```powershell
git clone <リポジトリURL> law-review
cd law-review
```

---

## 3. 環境変数ファイル `.env.dev1` の作成

**.env.dev1 は .gitignore されているため、clone した環境には含まれません。** その環境用に新しく作る必要があります。

```powershell
# 例（PowerShell）
cp .env.dev1.example .env.dev1
# または
Copy-Item .env.dev1.example .env.dev1
```

その後、**必ず編集する項目**:

| 設定項目 | 説明 |
|----------|------|
| `GOOGLE_CLIENT_ID` / `GOOGLE_CLIENT_SECRET` | Google OAuth 用。開発用の OAuth クライアントを作成するか、既存の「承認済みの JavaScript 生成元」に `http://localhost:8081` と `http://localhost:3000` を追加する。 |
| `NEXT_PUBLIC_GOOGLE_CLIENT_ID` | 上と同じクライアント ID（フロント用）。 |
| `ANTHROPIC_API_KEY` | Anthropic（Claude）API キー。有効なキーに変更。 |
| `SECRET_KEY` | セッション用。開発ならそのままで可（本番では必ず変更）。 |
| `ADMIN_2FA_*` | 管理者 2FA を使う場合のみ設定。不要なら `ADMIN_2FA_ENABLED=false` でも可。 |

その他は `.env.dev1.example` のコメントの通り。`CADDYFILE_DEV_PATH` はすでに `./Caddyfile.dev.local` になっており、**起動時に `dev1-up.ps1` で環境変数も設定される**ため、多くの場合はそのままで問題ありません。

---

## 4. データディレクトリ（任意）

- デフォルトでは **`./data`** がコンテナの `/data` にマウントされます。
- 初回起動時、DB が無ければ **`/data/dev.db`** が自動作成されます。
- 既存の `data/*.db` や `data/json/` を使いたい場合は、その環境用に `data` を用意するか、別マシンからコピーする。

---

## 4-2. この環境の DB を別環境へコピーする

いま動かしている環境の DB を、別 PC の開発環境で使いたい場合の手順です。

### DB の場所

| 環境 | ファイル | 場所（ホスト） |
|------|----------|----------------|
| dev（ローカル） | dev.db | `law-review/data/dev.db` |
| β | beta.db | `law-review/data/beta.db` |
| 本番 | prod.db | `law-review/data/prod.db` |

データディレクトリを変更している場合は、`.env.dev1` 等の `LAW_REVIEW_DATA_DIR` で指定したパス内にあります。

### コピー手順

**1) コピー元（この環境）で**

- コンテナを止めてからコピーすると安全です（書き込み中のファイルを避けるため）。
  ```powershell
  docker compose --profile dev down
  ```
- コピーするファイルを用意する。
  - **DB だけ**使う場合: `data/dev.db`（または beta.db / prod.db）を USB やクラウドで渡す。
  - **問題データ（JSON）も含めたい場合**: `data/` フォルダごとコピー（`data/*.db` と `data/json/` など）。

**2) コピー先（別環境）で**

- clone した `law-review` の **`data`** フォルダを用意する（無ければ `mkdir data`）。
- コピーした `dev.db` を **`law-review/data/dev.db`** に置く。
- `data/` ごとコピーした場合は、その中身を `law-review/data/` に上書きまたはマージする。

**3) 起動**

- 別環境で `.\scripts\dev1-up.ps1` を実行。`.env.dev1` の `DATABASE_URL=sqlite:////data/dev.db` のままなら、`data/dev.db` がそのまま使われます。

### 注意

- `*.db` は .gitignore されているため、Git では共有されません。手動または別手段でコピーする必要があります。
- 本番の `prod.db` をコピーする場合は、個人情報等の取り扱いに注意してください。

---

## 5. 起動方法

**推奨**: スクリプトで起動（`DEV_ENV_FILE` と `CADDYFILE_DEV_PATH` が自動で設定されます）。

```powershell
cd law-review
.\scripts\dev1-up.ps1
```

- **Proxy 経由**: http://localhost:8081  
- **接続拒否時**: http://localhost:3000（web-dev-server 直）

手動で起動する場合:

```powershell
$env:DEV_ENV_FILE = ".env.dev1"
$env:CADDYFILE_DEV_PATH = "./Caddyfile.dev.local"
docker compose --profile dev up -d
```

---

## 6. 起動確認

```powershell
docker compose --profile dev ps
```

`backend-dev` / `web-dev-server` / `proxy-dev` の 3 つが **running** になっていれば OK。  
問題があれば:

```powershell
docker compose --profile dev logs backend-dev web-dev-server proxy-dev
```

でログを確認。

---

## 7. よくあるトラブル

| 現象 | 対処 |
|------|------|
| 8081 が接続拒否 | 1) `.env.dev1` が存在するか確認 2) **`.\scripts\dev1-up.ps1`** で起動しているか確認 3) `docker compose --profile dev ps` で 3 コンテナが running か確認 |
| Google ログインがエラー | Google Cloud Console → 認証情報 → 該当 OAuth クライアントの「承認済みの JavaScript 生成元」に **http://localhost:8081** と **http://localhost:3000** を追加。反映に 5〜10 分かかることがある。 |
| 管理者ページで β/本番 DB が出ない | `data/` に該当 DB が無いため。dev のみでよければ `dev.db` だけで可。必要なら `data` を別環境からコピーするか、`LAW_REVIEW_DATA_DIR` で参照先を変更。 |

---

## チェックリスト（別環境で localhost 開発）

- [ ] Docker Desktop をインストールし、起動している
- [ ] リポジトリを clone した
- [ ] `.env.dev1.example` をコピーして `.env.dev1` を作成した
- [ ] `.env.dev1` で Google OAuth・Anthropic API キー等を編集した
- [ ] （Google ログインを使う場合）承認済み JavaScript 生成元に localhost を追加した
- [ ] `.\scripts\dev1-up.ps1` で起動した
- [ ] http://localhost:8081 または http://localhost:3000 でアクセスできる

---

**まとめ**: 別環境では **Docker Desktop のインストール** と **`.env.dev1` の作成・編集** が必須です。あとは `.\scripts\dev1-up.ps1` で起動すれば localhost 開発を開始できます。
