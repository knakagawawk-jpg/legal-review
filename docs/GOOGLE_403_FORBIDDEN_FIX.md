# Google認証 403 Forbidden エラーの解決方法

## 🔍 エラーの意味

`403 Forbidden`エラーは、Google Cloud Consoleで**クライアントIDとオリジンの組み合わせが許可されていない**ことを示しています。

## 🎯 解決手順

### Step 1: Google Cloud ConsoleでOAuth 2.0クライアントIDを確認

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. プロジェクトを選択
3. 「APIとサービス」→「認証情報」を選択
4. OAuth 2.0 クライアントID（`1093021444246-rv37t7gccj4so0jnu5ulben0l85v5l4h.apps.googleusercontent.com`）をクリック

### Step 2: 「承認済みのJavaScript生成元」を確認・追加

**重要:** 以下のURIが**正確に**追加されているか確認してください：

- `http://localhost:8080`（**末尾にスラッシュなし**）
- `http://127.0.0.1:8080`（念のため追加推奨）

**注意点:**
- `https://localhost:8080`ではなく、`http://localhost:8080`である必要があります
- 末尾にスラッシュ（`/`）を付けないでください
- プロトコル（`http://`）を含める必要があります
- ポート番号（`:8080`）を含める必要があります

### Step 3: 「承認済みのリダイレクトURI」を確認・追加

以下のURIも追加されているか確認してください：

- `http://localhost:8080`
- `http://localhost:8080/`
- `http://127.0.0.1:8080`
- `http://127.0.0.1:8080/`

### Step 4: OAuth同意画面の設定を確認

1. 「APIとサービス」→「OAuth同意画面」を選択
2. 「公開ステータス」が「テスト」または「本番」になっているか確認
3. 「テストユーザー」に自分のGoogleアカウントが追加されているか確認（テストモードの場合）

### Step 5: 設定を保存して反映を待つ

1. すべての設定を保存
2. **5-10分待つ**（設定の反映に時間がかかる場合があります）
3. ブラウザのキャッシュをクリア（`Ctrl+Shift+R`でハードリロード）

### Step 6: 再度テスト

1. ブラウザを完全に閉じて再起動
2. `http://localhost:8080`にアクセス
3. 「Googleでログイン」ボタンをクリック

## 🔧 よくある問題と解決方法

### 問題1: 設定を保存したが反映されない

**解決方法:**
- 5-10分待ってから再度試す
- ブラウザのキャッシュをクリア
- 別のブラウザで試す
- シークレットモードで試す

### 問題2: `http://localhost:8080`は追加されているが、`http://127.0.0.1:8080`は追加されていない

**解決方法:**
- ブラウザによっては`localhost`ではなく`127.0.0.1`でアクセスされる場合があります
- 両方を追加してください

### 問題3: ポート番号が間違っている

**解決方法:**
- Docker Composeを使用している場合、`http://localhost:8080`が正しいです
- `npm run dev`を使用している場合、`http://localhost:3000`が必要です
- 実際に使用しているポート番号を確認してください

### 問題4: OAuth同意画面が「テスト」モードで、テストユーザーに追加されていない

**解決方法:**
- 「OAuth同意画面」→「テストユーザー」に自分のGoogleアカウントを追加
- または、「公開ステータス」を「本番」に変更（本番環境の場合）

## 📋 確認チェックリスト

- [ ] Google Cloud ConsoleでOAuth 2.0クライアントIDを開いた
- [ ] 「承認済みのJavaScript生成元」に`http://localhost:8080`が追加されている（末尾にスラッシュなし）
- [ ] 「承認済みのJavaScript生成元」に`http://127.0.0.1:8080`が追加されている（念のため）
- [ ] 「承認済みのリダイレクトURI」に`http://localhost:8080`が追加されている
- [ ] OAuth同意画面の設定が完了している
- [ ] 設定を保存した
- [ ] 5-10分待った
- [ ] ブラウザのキャッシュをクリアした
- [ ] ブラウザを再起動した

## 💡 デバッグのヒント

### ブラウザのコンソールで確認

1. 開発者ツール（F12）を開く
2. 「Console」タブで以下を確認：
   - `Current origin:`の値
   - `Client ID:`の値

### ネットワークタブで確認

1. 開発者ツール（F12）を開く
2. 「Network」タブを選択
3. 「Googleでログイン」ボタンをクリック
4. `accounts.google.com/gsi/status`へのリクエストを確認
5. リクエストヘッダーの`origin`が`http://localhost:8080`であることを確認
6. レスポンスのステータスコードを確認

## 🔄 それでも解決しない場合

1. **別のOAuth 2.0クライアントIDを作成**して試す
2. **別のGoogleアカウント**で試す
3. **別のブラウザ**で試す
4. **シークレットモード**で試す
5. Google Cloud Consoleの**サポート**に問い合わせる

## 📝 まとめ

403 Forbiddenエラーは、Google Cloud Consoleでの設定が不完全または間違っている場合に発生します。

**最も可能性が高い原因:**
1. 「承認済みのJavaScript生成元」に`http://localhost:8080`が追加されていない
2. 設定が保存されていない、または反映されていない
3. OAuth同意画面の設定が不完全

**重要:** 設定を変更した後は、**必ず保存**し、**5-10分待ってから**再度試してください。
