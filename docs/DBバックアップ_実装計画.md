# DB自動バックアップ 実装計画

## 1. 前提・現状

- **DB**: SQLite（`DATABASE_URL`、デフォルト `sqlite:///./data/dev.db`）
- **環境**: Windows（タスクスケジューラで実行を想定）
- **保存先**: OneDrive（ローカル同期フォルダに保存し、クラウドへ自動同期）

**時刻について**: 「28:00」= 翌朝4:00（24+4）として扱う。実装では設定可能にする。

---

## 2. 要件の整理

| 項目 | 内容 |
|------|------|
| 実行時刻 | 毎日 28:00（= 4:00 AM）に1回 |
| 日次 | 毎回バックアップを取得し、OneDriveに保存。**日次は一定期間で破棄**（後述） |
| 週次 | 日曜 28:00 のバックアップを「週次スナップショット」として**別名で永続保存** |
| 保存先 | OneDrive 内の指定フォルダ: `C:\Users\tvxqt\OneDrive\01_Juristutor-AI\90_lawreview-backups` |

---

## 3. フォルダ・ファイル設計

OneDrive 内の例（実際のルート）:

```
C:\Users\tvxqt\OneDrive\01_Juristutor-AI\90_lawreview-backups/
├── daily/                    # 日次（ローテーションで削除）
│   └── dev_2025-02-18_0400.db
└── weekly/                   # 週次（長期保存）
    └── dev_2025-02-16_weekly.db   # 日曜 28:00 のスナップショット
```

- **日次ファイル名**: `{DB名}_{YYYY-MM-DD}_{HHMM}.db`（例: `dev_2025-02-18_0400.db`）
- **週次ファイル名**: `{DB名}_{日曜の日付}_weekly.db`（例: `dev_2025-02-16_weekly.db`）

DB名は `DATABASE_URL` のファイル名から取得（例: `dev.db` → `dev`）。

---

## 4. 日次バックアップの「いい感じで破棄」

候補:

| 方式 | 内容 | メリット | デメリット |
|------|------|----------|------------|
| **A. 直近N日分のみ保持** | 例: 直近7日分だけ daily/ に残す | シンプル、容量予測しやすい | 7日以上前の日次は残らない |
| **B. 1ファイル上書き** | 日次は常に1ファイル（例: `daily/latest.db`）で上書き | 常に1個だけ、管理が簡単 | 日次で複数世代は残らない |
| **C. 日次は保存しない** | 日曜のみ週次として保存 | 最もシンプル、容量最小 | 平日の復元ポイントがない |

**推奨**: **A（直近7日）**  
- 平日の「昨日」「一昨日」の復元が可能  
- 週次と組み合わせて、日次7日 + 週次数週〜数ヶ月 の運用が現実的  

設定例: `DAILY_BACKUP_RETENTION_DAYS=7`（環境変数または設定ファイルで変更可能にする）。

---

## 5. バックアップ取得方法（SQLite）

- **方式**: ファイルの**コピー**でよい（SQLiteは1ファイルで完結）
- **オプション**: 整合性を重視する場合は `sqlite3` の `.backup` で別ファイルに出力（VACUUM 相当の圧縮も可能）
- 本番では、バックアップ実行中にアプリが書き込まないよう、**短時間でコピー**するか、アプリ側の負荷が低い 4:00 実行で許容する

実装の選択肢:

1. **shutil.copy2(src, dst)**  
   - 実装が簡単。実行中にDBが更新されると一瞬不整合の可能性はあるが、4:00 ならリスクは低い。
2. **sqlite3.connect().backup()**  
   - バックアップ用の一貫したスナップショットが取れる。ややコードが増える。

**推奨**: まずは **shutil.copy2** で開始し、必要なら後から `.backup()` に差し替え可能にする。

---

## 6. 実行の仕組み（スケジュール）

| 方式 | 内容 | メリット | デメリット |
|------|------|----------|------------|
| **Windows タスクスケジューラ** | 毎日 4:00 にバッチ/スクリプトを実行 | OS標準、PCがスリープでなければ確実、アプリと独立 | PCの電源・スリープに依存 |
| **Python 常駐スクリプト（APScheduler等）** | アプリとは別プロセスで時刻指定実行 | アプリと同じマシンで一元管理可能 | 常駐プロセスが必要 |

**推奨**: **Windows タスクスケジューラ**  
- バックアップはアプリと独立させたい  
- 既存の FastAPI アプリにスケジューラを載せると、再起動・デプロイの影響を受ける  

実装イメージ:  
「毎日 4:00 に `scripts/backup_db.py` を実行する」タスクを1本登録する。  
スクリプト内で「今日が日曜か」を判定し、  
- 毎回: 日次用にコピー → daily/ に保存 → 古い日次を N 日分残して削除  
- 日曜のみ: 同じファイルを weekly/ に `*_weekly.db` でコピー（または日次コピーを weekly にリネームして保存）

---

## 7. OneDrive の扱い

- **パス**: 設定で指定。既定値: `C:\Users\tvxqt\OneDrive\01_Juristutor-AI\90_lawreview-backups`
- **環境変数例**: `BACKUP_ONEDRIVE_ROOT=C:\Users\tvxqt\OneDrive\01_Juristutor-AI\90_lawreview-backups`
- スクリプトは「指定ディレクトリに書き込む」だけにし、OneDrive クライアントによる同期は既存の仕組みに任せる。
- 同期失敗時は OneDrive 側の通知・ログで対応。必要ならスクリプトで「書き込み先の存在チェック」のみ行う。

---

## 8. 実装コンポーネント一覧

| 番号 | コンポーネント | 内容 |
|------|----------------|------|
| 1 | **バックアップスクリプト** | `law-review/scripts/backup_db.py`（または `tools/` 配下） |
| 2 | **設定** | 環境変数 または `law-review/.env` に `BACKUP_*` を追加（例: 実行時刻は「28:00」を 4 として扱う設定） |
| 3 | **タスクスケジューラ登録用** | 手順書 または `scripts/setup_backup_task.ps1`（PowerShellでタスク作成の例） |
| 4 | **ドキュメント** | 本計画書 + 運用メモ（保存先・保持日数・復元手順） |

---

## 9. スクリプトの処理フロー（案）

```
1. 設定読み込み
   - DATABASE_URL → 対象DBファイルパス
   - BACKUP_ONEDRIVE_ROOT → OneDrive 保存根
   - DAILY_BACKUP_RETENTION_DAYS（省略時 7）
   - 実行時刻は「28:00」固定なら 4:00 として扱う（必要なら BACKUP_HOUR=4 を追加）

2. 対象DBファイルの存在チェック

3. 現在日時を取得
   - 今日が日曜か判定

4. 日次バックアップ
   - ファイル名: {dbname}_{YYYY-MM-DD}_0400.db
   - 保存: {BACKUP_ONEDRIVE_ROOT}/daily/
   - 作成: コピー（shutil.copy2）

5. daily/ のローテーション
   - daily/ 内のファイル一覧を取得
   - 日付でソートし、古い方から (件数 - N) を削除（N = DAILY_BACKUP_RETENTION_DAYS）

6. 週次バックアップ（日曜の場合のみ）
   - ファイル名: {dbname}_{日曜日付}_weekly.db
   - 保存: {BACKUP_ONEDRIVE_ROOT}/weekly/
   - 今日作成した日次ファイルを weekly にコピー（または同じコピーを weekly としても作成）

7. ログ出力（成功・失敗・削除したファイル数など）
```

---

## 10. 設定項目まとめ（案）

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `DATABASE_URL` | 既存。バックアップ対象DB | `sqlite:///./data/dev.db` |
| `BACKUP_ONEDRIVE_ROOT` | OneDrive 内のバックアップルート | `C:\Users\tvxqt\OneDrive\01_Juristutor-AI\90_lawreview-backups` |
| `DAILY_BACKUP_RETENTION_DAYS` | 日次を何日分保持するか | `7` |
| （オプション）`BACKUP_HOUR` | 何時実行とみなすか（ログ用など） | `4` |

---

## 11. 週次の保持本数

- 週次は「毎週日曜の1本」が増えていくだけなので、**容量に応じて手動または別ジョブで削除**する想定でよい。
- 必要なら「週次は直近 N 週分だけ保持」するロジックを後から追加可能（例: 12週 = 約3ヶ月）。

---

## 12. 次のステップ（実装済み後の確認）

1. **`.env` の設定**  
   - `BACKUP_ONEDRIVE_ROOT=C:\Users\tvxqt\OneDrive\01_Juristutor-AI\90_lawreview-backups`  
   - ローカルでバックアップする場合は `DATABASE_URL=sqlite:///./data/dev.db` など、実在するDBを指定  

2. **手動実行で確認**  
   - `cd law-review && python scripts/backup_db.py`  
   - `90_lawreview-backups/daily/` に日次ファイルができること、日曜なら `weekly/` にもできることを確認  

3. **タスクスケジューラの登録**  
   - `.\scripts\setup_backup_task.ps1` を実行して毎日 4:00 のタスクを登録  

4. **復元テスト（推奨）**  
   - 下記「13. 復元テスト」の手順で1回は実施する。  

---

## 13. 復元テスト（推奨）

**要不要**: **やった方がよい**。  
バックアップが「ファイルとして存在する」だけでは不十分で、**実際に SQLite として開けて中身が読めるか**を一度確認しておかないと、本番で復元しようとしたときに失敗する可能性がある。復元手順に慣れておく意味でも有効。

**頻度**: 自動化は必須ではない。**初回導入時に1回**＋余裕があれば**数ヶ月に1回**程度の手動確認で十分。

**手順（例）**:

1. アプリを止める（DBファイルをロックしないようにする）。
2. 現在の `data/dev.db` を別名で退避（例: `data/dev.db.before_restore_test`）。
3. バックアップ先（`90_lawreview-backups/daily/` または `weekly/`）から任意の `.db` を `data/dev.db` にコピー。
4. アプリを起動し、画面やAPIでデータが期待どおり見えるか確認。
5. 問題なければ退避した `dev.db.before_restore_test` を `data/dev.db` に戻し、本番運用に復帰。テスト用にコピーしたバックアップはそのまま残してよい。

**簡易チェックだけなら**: バックアップファイルを `sqlite3 backup.db "SELECT count(*) FROM sqlite_master;"` で開けるか確認するだけでも、ファイル破損の有無はある程度分かる。

---

## 14. 補足: 複数DB（dev / beta / prod）がある場合

- 現在は `DATABASE_URL` 1本を想定。
- 複数DBをバックアップする場合は、  
  - 環境変数で `DATABASE_URL` を切り替えてタスクを複数登録する、  
  または  
  - `BACKUP_DATABASE_URLS=url1,url2` のように複数指定し、スクリプトでループしてそれぞれバックアップする、  
  のどちらかで対応可能。まずは1DBで実装し、必要になったら拡張する形でよい。

---

以上を実装方針として固め、問題なければ「バックアップスクリプト実装」に進めます。
