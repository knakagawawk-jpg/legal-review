# 復習問題生成機能の更改

## 現在の概要と問題点
復習問題生成機能（`recent_review_problems`）は、ユーザーの最近の学習履歴を基に、LLMが復習問題を生成する機能です。現状は大量のデータをLLMに送り、LLMがその中から一部を選択して問題を生成する仕組みになっています。
これではコストがかさむとともに生成が安定しないため、以下の通り機能全体をリニューアルします。

現状についてはC:\Users\tvxqt\.shihou-zyuken2601\law-review\docs\復習問題生成_現状整理.md参照

## リニューアル版概要
目的：LLMに大量の学習履歴を渡す設計をやめる（トークン消費・出力不安定・重複回避がLLM依存）

そのために、サーバー側で
・候補（Candidate）を作る
・優先度付けして上位のみをLLMに渡す
・使用済みコンテンツを除外して重複を防ぐ
を行う


### 全体フロー
#### 0. content_uses（使用履歴）をユーザー単位で保持
過去にLLMへ投入したCandidate（コンテンツ）を記録し、再利用しない
「古くなったら自然に効かなくなる（TTL参照）」方式だが、DB節約のため14日レベル古くなったものは自動削除

#### 1. 生成（初回）
①ユーザーが生成ボタン押下
②サーバーが各ソースからfetchして Candidateプールを作成
③Candidateプールを優先度順に並べ、content_usesで除外しつつ 上位5件を選ぶ
④選んだ5件を content_usesにInsert（予約/確定）
⑤LLMへ「選ばれた5件」だけ渡して問題生成

#### 2. 再生成（同日）
①ユーザーが再生成ボタン押下
②同じCandidateプールから、content_usesで除外しつつ上位5件を選ぶ
③content_usesにInsert
④LLM問題生成

#### 3. 翌日以降
①翌日生成時も同様にCandidateプールを作り直す（生成ボタン押下時のみ）
②content_usesにより「直近日数の重複」を排除し、翌日も同じコンテンツが選ばれにくくする

### 優先度とフィルタリング

#### priority_score計算
- 日付が古い方が優先（新しい方が優先ではない）
- Review以外は当日のものは含めない（前日以降）
- Reviewのみ当日のものからも復習問題が出る

#### 最終選択フィルター（priority_score確定後）
候補が存在する場合、以下の優先順位で選択：
1. dashboard_itemから2問
2. review系（review_weakness/review_important/review_future）から1問
3. noteから1問

合計5件に満たない場合は、優先度順で補充

### 候補が5件未満の場合のフォールバック

1. **取得制限の緩和**（優先）
   - Dashboard: 50→100件（古い順）
   - Review: 古い3→5件
   - Thread: 古い3→5スレッド
   - Note: 古い3→5件
   - 同じ除外ルール（content_uses）のまま候補を増やす

2. **重複許容モード**（最後の手段）
   - それでも足りない場合のみ
   - 14日除外を部分的に解除
   - 例: `used_at >= now - 3days` だけ除外、など段階的に緩める


### Candidateの定義（内部共通フォーマット）

※ 従前のデータセットに加えnote_pagesも使用
※ 当面はDB保存しなくてもOK（同日再生成のため、プールはJSON保存推奨）

source_type: "dashboard_item" | "review_weakness" | "review_important" | "review_future" | "review_thread" | "free_thread" | "note"

source_id: 親テーブルPK

sub_id: reviewについてはweaknesses, important_points, future_considerationsをblock_numberごとにcandidateの1行とするため、block_numberを保持（他はNull）

content_date: ソースの鮮度基準（dashboard_date / created_at / last_message_at / updated_at）

subject_id: あれば（dashboard/review/note）
- dashboard: DashboardItem.subject
- review: UserReviewHistory.subject
- note: Notebook.subject_id（NotePage → NoteSection → Notebook経由で取得）

content: 全文（文のまま。但し文字数等制限あり）
dashboard_item → item + memo
review_weakness → description
review_important → what_is_lacking
review_future → content
review_thread → Messageのcontent（only role=user）
free_thread → Messageのcontent（only role=user）
- メッセージは`\n`で連結
note → note_pageの中身 等


priority_score: サーバーで計算する優先度（fetch後に計算）
- 日付が古い方が優先（新しい方が優先ではない）
- Review以外は当日のものは含めない（前日以降）
- Reviewのみ当日のものからも復習問題が出る


### content_uses（使用履歴）テーブル案

#### テーブル: content_uses

id PK
user_id
content_date（Candidateのcontent_date）
session_id（recent_review_problem_sessions.id）
used_at（timestamp）
source_type（Candidateのsource_typeと一致）
source_id
sub_id（nullable）

※ study_dateはsession側の学習日（4:00境界）として保持


#### 除外キー

基本：(source_type, source_id, sub_id一致) が使われていたら除外



### Candidateプール（Plan/Pool）

同日再生成でfetchを繰り返さないため、候補プールを保存。

※ study_dateは4:00境界の「学習日」


### 取得条件
#### DashboardItem

対象日：前日〜5日前までのすべて（当日は含めない）
除外：entry_type = 2 AND status IN (1,4)（Taskかつ未了/後で）

条件：user_id, deleted_at IS NULL

#### Review

期間：過去2週間（当日を含む）

条件：created_at >= now - 14days
created_at古い3件

#### ReviewThread

期間：過去2週間（当日は含めない）

対象：last_message_at >= now - 14days AND last_message_at < 当日の4:00
last_message_at古い3スレッド

#### FreeThread

期間：過去2週間（当日は含めない）

対象：last_message_at >= now - 14days AND last_message_at < 当日の4:00
last_message_at古い3スレッド

#### Note

期間：updated_at が 前日〜5日前の範囲（当日は含めない）
その範囲内で updated_at古い3件

### 取得制限
#### DashboardItem

最大50件（古い順）

#### Review

1答案につき最大5件（review_weakness/review_important/review_future合わせて）
block_number上位からとり、review_weaknessの1,2、review_importantの1,2、review_futureの1を取得。5件に足りない場合はweakness→review_important→review_futureの順に1件ずつ取っていって5件に満つるまで（但し基本的には5件以上あるはず）


#### ReviewThread

1スレッドにつき、Messageのcontent（only role=user）を3つまで
*最初/真ん中/最後をとり、単純に連結（\n）
但し1messageにつき200文字まで（先頭）
3件未満の場合は1件のみ取得

#### FreeThread

1スレッドにつき、Messageのcontent（only role=user）を3つまで
*最初/真ん中/最後をとり、単純に連結（\n）
但し1messageにつき200文字まで（先頭）
3件未満の場合は1件のみ取得


#### Note

1note_pageにつき500文字まで