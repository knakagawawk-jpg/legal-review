# 復習問題生成機能の現状整理

## 概要
復習問題生成機能（`recent_review_problems`）は、ユーザーの最近の学習履歴を基に、LLMが復習問題を生成する機能です。現状は大量のデータをLLMに送り、LLMがその中から一部を選択して問題を生成する仕組みになっています。

## 関連ファイル一覧

### プロンプトファイル
- `law-review/prompts/main/recent_review_problems.txt`
  - LLMに送るプロンプトテンプレート
  - プレースホルダー: `{STUDY_DATE}`, `{DASHBOARD_ITEMS_JSON}`, `{REVIEWS_JSON}`, `{REVIEW_CHAT_THREADS_JSON}`, `{FREE_CHAT_THREADS_JSON}`, `{PREVIOUS_QUESTIONS_JSON}`

### APIエンドポイント
- `law-review/app/main.py`
  - **POST** `/v1/recent-review-problems/sessions` (行3350-3500付近)
    - 復習問題セッションを生成するエンドポイント
    - リクエスト: `RecentReviewProblemGenerateRequest` (source_session_id: Optional[int])
    - レスポンス: `RecentReviewProblemSessionResponse`
  - **GET** `/v1/recent-review-problems/sessions` (行3264-3347)
    - 復習問題セッション一覧を取得するエンドポイント

### LLM呼び出し
- `law-review/app/llm_service.py`
  - `generate_recent_review_problems()` (行446-537)
    - プロンプトを受け取り、Anthropic APIを呼び出して問題を生成
    - 返り値: `(items, raw_output, model_name, input_tokens, output_tokens, request_id, latency_ms)`

### データベースモデル
- `law-review/app/models.py`
  - `RecentReviewProblemSession` (行987付近): 復習問題生成セッション
  - `RecentReviewProblem` (行1026付近): 生成された問題
  - `DashboardItem` (行880-926): ダッシュボード項目
  - `Review` (行143-215): 講評データ
  - `Thread` (行218-256): チャットスレッド
  - `Message` (行261-301): チャットメッセージ
  - `UserReviewHistory` (行842付近): ユーザーの講評利用履歴

### スキーマ定義
- `law-review/app/schemas.py`
  - `RecentReviewProblemGenerateRequest` (行572-574)
  - `RecentReviewProblemResponse` (行536-548)
  - `RecentReviewProblemSessionResponse` (行550-560)
  - `RecentReviewProblemSessionsResponse` (行563-569)

## データ取得の流れ

### 1. Dashboard Items（ダッシュボード項目）
**取得箇所**: `main.py` 行3383-3395

```python
# 直近4日、最大20件
ymds = _get_recent_ymds(sd, 4)  # 学習日から4日前までの日付リスト
dash_items = (
    db.query(DashboardItem)
    .filter(
        DashboardItem.user_id == current_user.id,
        DashboardItem.deleted_at.is_(None),
        DashboardItem.dashboard_date.in_(ymds),
    )
    .order_by(DashboardItem.dashboard_date.desc(), DashboardItem.position.asc())
    .limit(20)
    .all()
)
```

**フォーマット関数**: `_format_dashboard_items_for_llm()` (行3156-3167)
- 出力形式:
  ```json
  {
    "dashboard_date": "YYYY-MM-DD",
    "subject_id": 1-18 or null,
    "item": "項目本文",
    "memo": "メモ（nullable）"
  }
  ```

**データベース構造** (`DashboardItem`):
- `dashboard_date`: 学習日（YYYY-MM-DD）
- `entry_type`: 1=Point, 2=Task
- `subject`: 科目ID（1-18、NULL可）
- `item`: 項目本文
- `memo`: メモ（自由記述、nullable）
- `status`: 1=未了, 2=作業中, 3=完了, 4=後で
- `deleted_at`: ソフト削除日時（NULLでない場合は除外）

### 2. Reviews（講評）
**取得箇所**: `main.py` 行3397-3424

```python
# 直近1週間、最大2件
one_week_ago_utc = datetime.now(ZoneInfo("UTC")) - timedelta(days=7)
reviews = (
    db.query(Review)
    .filter(
        Review.user_id == current_user.id,
        Review.created_at >= one_week_ago_utc,
    )
    .order_by(Review.created_at.desc())
    .limit(2)
    .all()
)
```

**フォーマット処理**: 行3409-3424
- `review_json_obj`: `Review.kouhyo_kekka` をJSONパース
- `UserReviewHistory` から `subject`, `question_title` を取得
- `_safe_review_eval_subset()` で `evaluation` の一部のみ抽出

**出力形式**:
```json
{
  "review_id": int,
  "created_at": "ISO形式の日時",
  "subject_id": 1-18 or null,
  "question_title": "問題タイトル（nullable）",
  "evaluation_subset": {
    "weaknesses": [
      {
        "block_number": 1,
        "category": "論点の拾い上げ" | "規範定立" | "あてはめ" | "結論" | "構造" | "その他",
        "description": "改善点の具体的な説明",
        "paragraph_numbers": [3, 4]（該当する場合のみ）,
        "suggestion": "具体的な改善提案（任意）"
      },
      ...
    ],
    "important_points": [
      {
        "block_number": 1,
        "paragraph_number": 1,
        "what_is_good": "この段落で十分に書けている点",
        "what_is_lacking": "この段落で不足している点",
        "why_important": "こう変えればより良いという点"
      },
      ...
    ],
    "future_considerations": [
      {
        "content": "今後意識すべきこと1",
        "block_number": 1
      },
      ...
    ]
  }
}
```

**データベース構造** (`Review`):
- `kouhyo_kekka`: LLMの出力結果（JSON/JSONB）
  - 内部構造: `{"evaluation": {"strengths": [...], "weaknesses": [...], "important_points": [...], "future_considerations": [...]}}`
  - LLMは重要度の高いものから順に `block_number: 1, 2, 3...` を付与（プロンプト指示による）
  - 各要素の構造:
    - `strengths`: `[{"block_number": 1, "category": "...", "description": "...", "paragraph_numbers": [...]}, ...]`
    - `weaknesses`: `[{"block_number": 1, "category": "...", "description": "...", "paragraph_numbers": [...], "suggestion": "..."}, ...]`
    - `important_points`: `[{"block_number": 1, "paragraph_number": 1, "what_is_good": "...", "what_is_lacking": "...", "why_important": "..."}, ...]`
    - `future_considerations`: `[{"block_number": 1, "content": "..."}, ...]` または `["...", ...]`（後方互換性）
- `answer_text`: ユーザー答案
- `thread_id`: チャットスレッドID（nullable）
- `UserReviewHistory`: 講評利用履歴（subject, question_title等を保存）

**評価データ抽出関数**: `_safe_review_eval_subset()` (行3146-3153)
- `evaluation.strengths`: 評価した点（各要素に `block_number` を付与、重要度順に1,2,3...）※復習問題生成では使用しないが、データ共通化のため処理
- `evaluation.weaknesses`: 改善点（各要素に `block_number` を付与、重要度順に1,2,3...）
- `evaluation.important_points`: 重要なポイント（各要素に `block_number` を付与、重要度順に1,2,3...）
- `evaluation.future_considerations`: 今後の検討事項（文字列をdictに変換し `block_number` を付与、重要度順に1,2,3...）

**block_numberについて**:
- 各カテゴリ（strengths, weaknesses, important_points, future_considerations）ごとに独立して1から番号を振る
- `review_id` と `block_number` の組み合わせで、特定のブロックを一意に識別可能
- 例: `review_id: 123, block_number: 1` → weaknesses の1番目（最重要の改善点）
- 既存データで `block_number` がない場合、抽出時に自動的に1から順番に付与される（後方互換性）
- 復習問題生成では `weaknesses`, `important_points`, `future_considerations` のみ使用（`strengths` は将来の拡張用）

### 3. Review Chat Threads（講評チャット）
**取得箇所**: `main.py` 行3426, `_format_review_chat_threads_for_llm()` (行3203-3227)

```python
# reviewsに対応するチャットスレッドを取得
# 各スレッドの最大10メッセージ
for r in reviews:
    if not r.thread_id:
        continue
    th = db.query(Thread).filter(Thread.id == r.thread_id).first()
    if not th or th.type != "review_chat":
        continue
    msgs = (
        db.query(Message)
        .filter(Message.thread_id == th.id)
        .order_by(Message.created_at.desc())
        .limit(10)
        .all()
    )
```

**出力形式**:
```json
{
  "review_id": int,
  "thread_id": int,
  "title": "スレッドタイトル",
  "messages": [
    {"role": "user|assistant|system", "content": "メッセージ内容"},
    ...
  ]
}
```

**データベース構造**:
- `Thread.type == "review_chat"`: 講評チャット
- `Message`: スレッドに紐づくメッセージ（最大10件、時系列順）

### 4. Free Chat Threads（フリーチャット）
**取得箇所**: `main.py` 行3427, `_format_free_chat_threads_for_llm()` (行3170-3200)

```python
# 最新5スレッド、各スレッドの直近10メッセージ
threads = (
    db.query(Thread)
    .filter(
        Thread.user_id == user_id,
        Thread.type == "free_chat",
        Thread.last_message_at.isnot(None),
    )
    .order_by(Thread.last_message_at.desc())
    .limit(5)
    .all()
)
```

**出力形式**:
```json
{
  "thread_id": int,
  "title": "スレッドタイトル",
  "last_message_at": "ISO形式の日時",
  "messages": [
    {"role": "user|assistant|system", "content": "メッセージ内容"},
    ...
  ]
}
```

**データベース構造**:
- `Thread.type == "free_chat"`: フリーチャット
- `Thread.last_message_at`: 最後のメッセージ日時（並び替え用）

### 5. Previous Questions（過去出題済み問題）
**取得箇所**: `main.py` 行3363-3381

```python
# 同日セッションすべてから問題文を取得
prev_sessions = (
    db.query(RecentReviewProblemSession.id)
    .filter(
        RecentReviewProblemSession.user_id == current_user.id,
        RecentReviewProblemSession.study_date == sd,
        RecentReviewProblemSession.status == "success",
    )
    .all()
)
prev_probs = (
    db.query(RecentReviewProblem.question_text)
    .filter(RecentReviewProblem.session_id.in_(prev_session_ids))
    .all()
)
```

**出力形式**: 文字列の配列
```json
["問題文1", "問題文2", ...]
```

**用途**: 重複回避（プロンプト内で「同じ問題を繰り返さない」ように指示）

## プロンプト生成の流れ

### 1. データのJSON化
**箇所**: `main.py` 行3429-3433

```python
dashboard_items_json = json.dumps(_format_dashboard_items_for_llm(dash_items), ensure_ascii=False, indent=2)
reviews_json = json.dumps(reviews_payload, ensure_ascii=False, indent=2)
review_chat_threads_json = json.dumps(review_chat_threads_payload, ensure_ascii=False, indent=2)
free_chat_threads_json = json.dumps(free_chat_threads_payload, ensure_ascii=False, indent=2)
previous_questions_json = json.dumps(prev_questions, ensure_ascii=False, indent=2)
```

### 2. テキストの切り詰め
**箇所**: `main.py` 行3435-3442, `_truncate_text()` (行223-230)

```python
prompt_text = _build_recent_review_prompt(
    study_date=sd,
    dashboard_items_json=_truncate_text(dashboard_items_json, limit=12000),
    reviews_json=_truncate_text(reviews_json, limit=12000),
    review_chat_threads_json=_truncate_text(review_chat_threads_json, limit=12000),
    free_chat_threads_json=_truncate_text(free_chat_threads_json, limit=12000),
    previous_questions_json=_truncate_text(previous_questions_json, limit=8000),
)
```

**切り詰めロジック** (`_truncate_text`):
- 制限を超える場合、先頭70% + 末尾25%を残し、中間に「（中略）」を挿入

### 3. プロンプトテンプレートの置換
**箇所**: `main.py` 行3230-3249, `_build_recent_review_prompt()`

```python
template = _load_prompt_text("recent_review_problems")
return (
    template.replace("{STUDY_DATE}", study_date)
    .replace("{DASHBOARD_ITEMS_JSON}", dashboard_items_json)
    .replace("{REVIEWS_JSON}", reviews_json)
    .replace("{REVIEW_CHAT_THREADS_JSON}", review_chat_threads_json)
    .replace("{FREE_CHAT_THREADS_JSON}", free_chat_threads_json)
    .replace("{PREVIOUS_QUESTIONS_JSON}", previous_questions_json)
)
```

## LLM呼び出し

### 関数: `generate_recent_review_problems()`
**ファイル**: `llm_service.py` 行446-537

**パラメータ**:
- `prompt`: 生成されたプロンプトテキスト
- `max_tokens`: 4096（デフォルト）
- `temperature`: 0.4（デフォルト）

**処理**:
1. Anthropic APIクライアントを作成
2. システムプロンプトを設定
3. メッセージを作成（プロンプト + JSON出力指示）
4. API呼び出し
5. レスポンスからJSONを抽出・パース
6. 最大5件の問題を返す

**返り値**:
```python
(
    items: list[Dict[str, Any]],  # 生成された問題のリスト
    raw_output: str,              # LLMの生レスポンス
    model_name: str,              # 使用したモデル名
    input_tokens: Optional[int],  # 入力トークン数
    output_tokens: Optional[int], # 出力トークン数
    request_id: Optional[str],    # リクエストID
    latency_ms: Optional[int]     # レイテンシ（ミリ秒）
)
```

**問題の形式**:
```json
{
  "subject_id": 1-18 or null,
  "question_text": "問題文",
  "answer_example": "答えの例",
  "references": "参照情報・考え方"
}
```

## データ量の現状

### 送信データの上限
- `dashboard_items_json`: 最大12,000文字（切り詰め後）
- `reviews_json`: 最大12,000文字（切り詰め後）
- `review_chat_threads_json`: 最大12,000文字（切り詰め後）
- `free_chat_threads_json`: 最大12,000文字（切り詰め後）
- `previous_questions_json`: 最大8,000文字（切り詰め後）

**合計**: 最大約56,000文字（切り詰め前はさらに大きくなる可能性）

### 取得データの件数
- Dashboard Items: **最大20件**（直近4日分）
- Reviews: **最大2件**（直近1週間）
- Review Chat Threads: **reviewsの数に応じて**（各最大10メッセージ）
- Free Chat Threads: **最大5スレッド**（各最大10メッセージ）
- Previous Questions: **同日セッションすべて**（制限なし）

## 改善の方向性

現状の問題点:
1. **大量のデータをLLMに送信**: 最大20件のdashboard items、最大5スレッドのfree chat（各10メッセージ）など、多くのデータを一度に送信
2. **LLMに選択を委ねる**: プロンプト内で「dashboard_itemsから2～3件、recent_reviewsから1～2件...」と指示しているが、実際には全データを送信している
3. **トークン消費が大きい**: 切り詰めを行っているものの、依然として大量のトークンを消費

改善案:
- **サーバー側で事前選択**: データ取得後、サーバー側で関連性の高い項目を選択してからLLMに送信
- **データ量の削減**: 選択した項目のみを送信することで、トークン消費を削減
- **選択ロジック**: 科目の関連性、日付の近さ、重要度などに基づいて選択

## 関連定数

- `RECENT_REVIEW_DAILY_LIMIT = 5` (`main.py` 行3134): 1日あたりの生成制限回数

## 各データの親データ保持形式

### DashboardItem
- `DashboardItem` テーブルから直接取得
- `user_id`, `dashboard_date`, `deleted_at` でフィルタ
- `dashboard_date` 降順、`position` 昇順でソート

**DashboardItem テーブルのカラム**:
- `id` (Integer, PK)
- `user_id` (Integer, FK: users.id)
- `dashboard_date` (String(10), 'YYYY-MM-DD')
- `entry_type` (Integer, 1=Point, 2=Task)
- `subject` (Integer, nullable, 1-18)
- `item` (Text, 項目本文)
- `due_date` (String(10), nullable, 'YYYY-MM-DD')
- `status` (Integer, 1=未了, 2=作業中, 3=完了, 4=後で)
- `memo` (Text, nullable, メモ)
- `position` (Integer, 並び順)
- `favorite` (Integer, 0=OFF, 1=ON)
- `created_at` (String(30))
- `updated_at` (String(30))
- `deleted_at` (String(30), nullable, ソフト削除日時)

### Reviews
- `Review` テーブルから取得
- `UserReviewHistory` テーブルとリレーション（`review_id`）で `subject`, `question_title` を取得
- `Review.kouhyo_kekka`（JSON/JSONB）から `evaluation` を抽出

**Review テーブルのカラム**:
- `id` (BigInteger/Integer, PK)
- `user_id` (BigInteger/Integer, FK: users.id, nullable)
- `created_at` (DateTime(timezone=True))
- `updated_at` (DateTime(timezone=True))
- `source_type` (String(10), 'official' or 'custom')
- `official_question_id` (BigInteger/Integer, FK: official_questions.id, nullable)
- `custom_question_text` (Text, nullable)
- `answer_text` (Text, ユーザー答案)
- `kouhyo_kekka` (JSONB/Text, LLMの出力結果)
- `thread_id` (Integer, FK: threads.id, nullable)
- `has_chat` (Boolean, チャット有無フラグ)

**UserReviewHistory テーブルのカラム**:
- `id` (BigInteger/Integer, PK)
- `user_id` (BigInteger/Integer, FK: users.id)
- `review_id` (BigInteger/Integer, FK: reviews.id)
- `subject` (Integer, nullable, 1-18)
- `exam_type` (String(20), nullable, "司法試験" or "予備試験")
- `year` (Integer, nullable, 年度)
- `score` (Numeric(5, 2), nullable, 点数)
- `attempt_count` (Integer, 同一試験に関する講評の回数)
- `question_title` (String(200), nullable, 問題タイトル)
- `reference_text` (Text, nullable, 参照文章)
- `created_at` (DateTime(timezone=True))

### Review Chat Threads
- `Review` テーブルから `thread_id` を取得
- `Thread` テーブルとリレーション（`Thread.id = Review.thread_id`、`Thread.type = "review_chat"`）
- `Message` テーブルとリレーション（`Message.thread_id = Thread.id`）

**Thread テーブルのカラム**:
- `id` (Integer, PK)
- `user_id` (Integer, FK: users.id)
- `type` (String(20), 'free_chat', 'review_chat', 'short_answer_chat')
- `created_at` (DateTime(timezone=True))
- `last_message_at` (DateTime(timezone=True), nullable, 最終発言日時)
- `title` (String(200), nullable, タイトル)
- `favorite` (Integer, 0=OFF, 1=ON)
- `pinned` (Boolean, 固定表示フラグ)

**Message テーブルのカラム**:
- `id` (Integer, PK)
- `thread_id` (Integer, FK: threads.id)
- `role` (String(20), 'user', 'assistant', 'system')
- `content` (Text, 本文)
- `created_at` (DateTime(timezone=True))
- `model` (String(100), nullable, 使用したLLMモデル名)
- `prompt_version` (String(50), nullable, プロンプトのバージョン)
- `input_tokens` (Integer, nullable, 入力トークン数)
- `output_tokens` (Integer, nullable, 出力トークン数)
- `cost_yen` (Numeric(10, 2), nullable, コスト（円）)
- `request_id` (String(255), nullable, 同一LLM呼び出しの重複計上防止用)

### Free Chat Threads
- `Thread` テーブルから直接取得（`type = "free_chat"`）
- `Message` テーブルとリレーション（`Message.thread_id = Thread.id`）

**Thread テーブルのカラム**: （上記と同じ）
**Message テーブルのカラム**: （上記と同じ）

### Previous Questions
- `RecentReviewProblemSession` テーブルから `id` を取得
- `RecentReviewProblem` テーブルとリレーション（`RecentReviewProblem.session_id = RecentReviewProblemSession.id`）

**RecentReviewProblemSession テーブルのカラム**:
- `id` (Integer, PK)
- `user_id` (Integer, FK: users.id)
- `study_date` (String(10), 'YYYY-MM-DD', 4:00境界の学習日)
- `mode` (String(20), 'generate' / 'regenerate')
- `source_session_id` (Integer, FK: recent_review_problem_sessions.id, nullable)
- `llm_model` (String(100), nullable, LLMモデル名)
- `prompt_version` (String(50), nullable, プロンプトのバージョン)
- `llm_raw_output` (Text, nullable, LLMの生出力)
- `error_message` (Text, nullable)
- `status` (String(20), 'success' / 'failed')
- `created_at` (DateTime(timezone=True))

**RecentReviewProblem テーブルのカラム**:
- `id` (Integer, PK)
- `session_id` (Integer, FK: recent_review_problem_sessions.id)
- `user_id` (Integer, FK: users.id)
- `order_index` (Integer, 1-5)
- `subject_id` (Integer, nullable, 1-18 or NULL)
- `question_text` (Text, 問題文)
- `answer_example` (Text, nullable, 答えの例)
- `references` (Text, nullable, 参照情報)
- `created_at` (DateTime(timezone=True))
