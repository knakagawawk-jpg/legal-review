# 講評結果ページ UI 問題の整理

## 更新日

2025 年 1 月現在

## 目指している UI レイアウト

### レイアウト構成図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ヘッダー（タイトル、戻るボタン）                    │
├─────────────────────────────────────────────────────────────────────────┤
│               [左右パネルの表示割合調整スライダー] (デフォルト4:6)          │
├──────────────────────────┬──────────────────────────────────────────────┤
│                          │                                               │
│   左パネル (40%)         │          右パネル (60%)                        │
│   固定高さ                │          固定高さ                              │
│   内部スクロール可能      │          内部スクロール可能                    │
│                          │                                               │
│   ┌──────────────────┐  │  ┌──────────────────────────────────────┐    │
│   │ 📝 答案 | 📄 問題 │  │  │ 📊 講評 | 📄 問題文 | 📋 詳細情報 │    │
│   ├──────────────────┤  │  ├──────────────────────────────────────┤    │
│   │                  │  │  │                                      │    │
│   │  答案テキスト     │  │  │  講評結果マークダウン                │    │
│   │  (スクロール可能) │  │  │  (スクロール可能)                    │    │
│   │                  │  │  │                                      │    │
│   │  または           │  │  │  または                              │    │
│   │                  │  │  │                                      │    │
│   │  問題文           │  │  │  問題文 / 出題趣旨                   │    │
│   │  出題趣旨         │  │  │                                      │    │
│   │  (スクロール可能) │  │  │  または                              │    │
│   │                  │  │  │                                      │    │
│   │                  │  │  │  JSON詳細情報                        │    │
│   │                  │  │  │  (スクロール可能)                    │    │
│   └──────────────────┘  │  └──────────────────────────────────────┘    │
│                          │                                               │
│   高さ: calc(100vh -     │   高さ: 左パネルと同じ（常に同じ高さ）        │
│         ヘッダー高さ -   │                                               │
│         スライダー高さ - │                                               │
│         チャット高さ)    │                                               │
├──────────────────────────┴──────────────────────────────────────────────┤
│                                                                           │
│   下部チャット欄 (固定高さ300px)                                          │
│   内部スクロール可能                                                      │
│   ┌───────────────────────────────────────────────────────────────────┐ │
│   │ 💬 講評について質問する                                            │ │
│   │ ──────────────────────────────────────────────────────────────── │ │
│   │                                                                    │ │
│   │   チャット履歴表示エリア (スクロール可能)                          │ │
│   │   - ユーザー質問                                                   │ │
│   │   - アシスタント回答                                               │ │
│   │                                                                    │ │
│   ├───────────────────────────────────────────────────────────────────┤ │
│   │ [質問入力欄_______________________] [送信] [履歴クリア]            │ │
│   └───────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

### レイアウトの特徴

1. **3 分割レイアウト**

   - 上部: ヘッダー + スライダー（固定高さ）
   - 中部: 左右パネル（同じ固定高さ、内部スクロール可能）
   - 下部: チャット欄（固定高さ 300px、内部スクロール可能）

2. **左右パネルの詳細**

   - **左パネル**:
     - タブ 1「📝 答案」: 提出された答案を表示
     - タブ 2「📄 問題文」: 問題文と出題趣旨を表示
   - **右パネル**:
     - タブ 1「📊 講評」: 生成された講評結果（マークダウン）を表示
     - タブ 2「📄 問題文」: 問題文と出題趣旨を表示（左パネルと同じ内容だが、右からもアクセス可能）
     - タブ 3「📋 詳細情報」: JSON 形式の詳細データを表示

3. **スクロール動作**

   - 各パネル・チャット欄は独立してスクロール可能
   - ページ全体のスクロールは発生しない（すべての要素が画面内に収まる）

4. **表示割合の調整**
   - スライダーで左右パネルの幅を調整可能（1:9 ～ 9:1）
   - デフォルトは 4:6（左 40%、右 60%）
   - 調整後も両パネルの高さは常に同じ

### 実装上の要件

- **固定高さ**: 左右パネルの高さは、画面高さからヘッダー・スライダー・チャット欄の高さを引いた値
- **常時表示**: 3 つの領域（左パネル、右パネル、チャット欄）が常に画面上に表示される
- **独立スクロール**: 各領域内でのみスクロールが発生し、ページ全体のスクロールは発生しない
- **レスポンシブ**: ウィンドウサイズが変更されても、レイアウトが適切に調整される

## 現状の要件

### 期待される動作

1. **固定レイアウト**: 左ウィンドウ、右ウィンドウ、下部チャット欄が常に画面上に表示されている
2. **独立したスクロール**: 各ウィンドウ内で独立してスクロール可能
3. **固定高さ**: 左右パネルは同じ固定高さを持ち、内容が長い場合は内部スクロールで対応
4. **調整可能な表示割合**: ユーザーが左右パネルの幅を調整可能（デフォルト 4:6）
5. **タブインターフェース**: 左パネルに「答案」「問題文」タブ、右パネルに「講評」「問題文」「詳細情報」タブ

## 現状の問題点

### 1. UI レイアウトの問題

#### 観察される症状

- **問題 1**: 表示割合調整 UI（スライダー）の下に左右のウィンドウが表示されるが、その中身が空
- **問題 2**: その下に、独立したウィンドウとしてではなく、ページ全体のスクロールと同期している「提出答案」や「講評結果」が表示される
- **問題 3**: さらに下にスクロールすると、下部チャット欄が表示される
- **問題 4**: 左右パネルが独立した固定高さを持たず、内容に応じて伸びてしまう

#### 根本原因

1. **Streamlit のレンダリングモデル**: Streamlit は React ベースで、コンポーネントが動的に生成・再レンダリングされる
2. **DOM 操作のタイミング問題**: JavaScript で DOM を操作しようとしても、Streamlit の再レンダリングによって変更が上書きされる
3. **コンポーネントの構造**: `st.columns`と`st.tabs`の組み合わせが、カスタム CSS/JavaScript と正しく連携していない
4. **HTML ラッパーの適用失敗**: `st.markdown`で注入した HTML ラッパーが、Streamlit のコンポーネントラッパー内に適切に適用されていない

### 2. 技術的な課題

#### JavaScript の適用タイミング

- `MutationObserver`で DOM 変更を監視しているが、Streamlit の再レンダリングサイクルと競合している可能性
- `setTimeout`で遅延実行しているが、タイミングが不安定
- `st.columns`で生成される DOM 要素の検索（`[data-testid="column"]`）が、期待する要素を正確に取得できていない可能性

#### CSS の適用範囲

- CSS セレクタ（`.review-panel-column`、`.stTabs`など）が、Streamlit が生成する DOM 構造と一致していない可能性
- Streamlit の内部クラス名や属性が変更される可能性があり、セレクタが脆弱
- `!important`を使用しているが、Streamlit の内部スタイルが優先されている可能性

#### Streamlit コンポーネントの制約

- `st.columns`と`st.tabs`は、それぞれ独自のラッパー要素を生成する
- これらのラッパー要素の DOM 構造が公式ドキュメントに記載されていない
- カスタム HTML/CSS を注入しても、Streamlit の再レンダリングによって削除される可能性

### 3. コードの問題点

#### `review_result.py`の実装の問題

1. **HTML ラッパーの混在**: `st.markdown`で HTML を注入しているが、`st.columns`や`st.tabs`の外側に適用する必要があるが、Streamlit の実行順序により適用位置が不安定
2. **JavaScript の依存**: DOM 要素の検索と操作に依存しているが、Streamlit の再レンダリングにより要素が見つからない場合がある
3. **チャットセクションの実装**: `st.markdown`で HTML ラッパーを注入しているが、その中で`st.chat_message`などの Streamlit コンポーネントを使用しているため、構造が複雑化

## 試行した解決策

### 1. CSS による固定高さ設定

- **アプローチ**: CSS の`height: calc(100vh - 500px)`で固定高さを設定
- **結果**: 適用されず、要素が展開し続ける

### 2. JavaScript による動的高さ計算と適用

- **アプローチ**: `setFixedPanelHeight()`関数でウィンドウ高さを計算し、動的に高さを設定
- **結果**: DOM 要素の検索に失敗するか、適用後に Streamlit の再レンダリングで上書きされる

### 3. MutationObserver による再適用

- **アプローチ**: DOM 変更を監視し、変更後に再適用
- **結果**: 無限ループのリスクがあり、パフォーマンスの問題が発生

### 4. HTML ラッパーの直接注入

- **アプローチ**: `st.markdown`で HTML の`<div>`を直接注入してラッパーを作成
- **結果**: Streamlit コンポーネント（`st.tabs`など）が HTML ラッパーの外側に生成される

### 5. Streamlit コンポーネントの直接使用

- **アプローチ**: HTML ラッパーを削除し、`st.columns`と`st.tabs`を直接使用
- **結果**: 固定高さとスクロールが適用されない

## 今後の解消方針

### オプション 1: Streamlit Components API を使用したカスタムコンポーネント開発（推奨）

#### 概要

Streamlit の`streamlit.components.v1`を使用して、固定高さ・スクロール可能なパネルをカスタムコンポーネントとして実装する。

#### メリット

- Streamlit の再レンダリングサイクルと完全に統合される
- React/JavaScript を直接制御できる
- 再利用可能なコンポーネントとして実装できる

#### デメリット

- 開発工数が大きい（React/TypeScript の知識が必要）
- メンテナンスコストが高い

#### 実装例の骨格

```python
# streamlit_app/components/scrollable_panel.py
import streamlit.components.v1 as components

def scrollable_panel(html_content: str, height: int = 500, key: str = None):
    """固定高さのスクロール可能なパネルコンポーネント"""
    components.html(
        f"""
        <div style="height: {height}px; overflow-y: auto; border: 1px solid #e0e0e0;">
            {html_content}
        </div>
        """,
        height=height
    )
```

### オプション 2: iframe を使用した分離レンダリング

#### 概要

左右パネルとチャット欄をそれぞれ`iframe`内でレンダリングし、親ページでレイアウトを制御する。

#### メリット

- Streamlit の再レンダリングから完全に分離される
- 各パネルが独立して動作する
- スクロールを完全に制御できる

#### デメリット

- パネル間のデータ共有が複雑になる
- パフォーマンスのオーバーヘッドがある
- 実装が複雑

### オプション 3: Streamlit の制約を前提とした設計変更

#### 概要

固定高さ・スクロール可能なパネルという要件を緩和し、Streamlit の標準的な動作（ページ全体のスクロール）を受け入れる。

#### 変更内容

1. 左右パネルを上下に配置（または、タブで切り替え）
2. 各セクションを Streamlit の標準コンポーネントで実装
3. スクロールはページ全体で行う

#### メリット

- 実装が簡単で安定
- Streamlit の標準機能のみを使用
- メンテナンスコストが低い

#### デメリット

- ユーザーの要件（固定レイアウト、独立スクロール）を満たさない

### オプション 4: 外部ライブラリの活用

#### 候補ライブラリ

1. **streamlit-option-menu**: タブメニューの代替
2. **streamlit-layout**: レイアウト管理（存在確認必要）
3. **streamlit-elements**: より高度な UI コンポーネント（存在確認必要）

#### 調査事項

- これらのライブラリが固定高さ・スクロール可能なパネルをサポートしているか
- Streamlit のバージョンとの互換性
- メンテナンス状況

### オプション 5: CSS Grid/Flexbox を活用した再実装

#### 概要

`st.markdown`で HTML 構造を完全に制御し、その中に`st.components.v1.html`で各パネルの内容を埋め込む。

#### 実装の骨格

```python
# CSS Gridで3分割レイアウト
st.markdown("""
<div style="display: grid; grid-template-rows: 1fr 1fr 300px; height: calc(100vh - 100px);">
    <div style="overflow-y: auto;">左パネル</div>
    <div style="overflow-y: auto;">右パネル</div>
    <div style="overflow-y: auto;">チャット</div>
</div>
""", unsafe_allow_html=True)
```

#### 課題

- Streamlit コンポーネント（`st.tabs`など）を HTML 内に埋め込む方法が不明
- `st.components.v1.html`でレンダリングした内容を、Streamlit の状態管理と統合する方法が不明

## 推奨される解決方針

### 短期対応（暫定解決）

**オプション 3（要件の緩和）**を推奨します。

理由:

1. 現状の実装で最も早く安定した動作を実現できる
2. Streamlit の標準機能のみを使用するため、メンテナンスが容易
3. ユーザーに要件の見直しを提案し、優先順位を確認できる

### 中期対応（根本解決）

**オプション 1（カスタムコンポーネント開発）**を推奨します。

理由:

1. ユーザーの要件（固定レイアウト、独立スクロール）を満たせる
2. Streamlit の再レンダリングサイクルと完全に統合される
3. 再利用可能なコンポーネントとして実装できるため、将来的に他ページでも活用できる

### 調査が必要な項目

1. **Streamlit Components API の詳細調査**

   - `streamlit.components.v1`の公式ドキュメント
   - サンプル実装の調査
   - React/TypeScript の知識要件

2. **外部ライブラリの調査**

   - `streamlit-option-menu`などの実装確認
   - 固定高さ・スクロール機能のサポート状況

3. **Streamlit のバージョンアップデート**
   - 最新バージョンでレイアウト機能が追加されていないか確認
   - 将来のバージョンでの改善予定があるか確認

## 技術的メモ

### Streamlit の DOM 構造について

- Streamlit は`react`ベースで動作しており、DOM 要素は動的に生成される
- `st.columns`は`[data-testid="column"]`属性を持つ要素を生成する
- `st.tabs`は`.stTabs`クラスを持つ要素を生成し、内部に`[data-baseweb="tab-list"]`と`[data-baseweb="tab-panel"]`を持つ
- これらの DOM 構造は公式ドキュメントに記載されていないため、バージョンアップで変更される可能性がある

### JavaScript の実行タイミング

- Streamlit はページ全体を再レンダリングするため、JavaScript で DOM 操作を行っても、次の再レンダリングで上書きされる可能性がある
- `MutationObserver`を使用しても、Streamlit の再レンダリングサイクルと競合する
- `st.components.v1.html`を使用することで、JavaScript を完全に制御できるが、Streamlit の状態管理（`st.session_state`）との連携が複雑になる

### CSS の適用優先度

- Streamlit の内部スタイルは高い優先度を持つ
- `!important`を使用しても、より具体的なセレクタを持つ Streamlit のスタイルが優先される場合がある
- `st.markdown`で注入した CSS は、Streamlit の内部スタイルよりも後に読み込まれるため、優先度の問題が発生しやすい

## 参考資料

### Streamlit 公式ドキュメント

- [Streamlit Components API](https://docs.streamlit.io/library/components)
- [Streamlit Components - Create a Component](https://docs.streamlit.io/library/components/create)

### 関連ファイル

- `law-review/streamlit_app/pages/review_result.py`: 現在の実装
- `law-review/streamlit_app/components/styles.py`: 共通スタイル
- `law-review/web.py`: メインエントリーポイント

### 関連ログ

- `law-review/logs/fastapi.log`: FastAPI サーバーのログ（UI 関連のエラーは記録されていない）
- `law-review/logs/streamlit.log`: Streamlit アプリのログ（UI 関連のエラーは記録されていない）

## 次のステップ

1. **ユーザーに要件の再確認を依頼**

   - 固定レイアウト・独立スクロールの要件が必須か確認
   - 暫定的な解決策（ページ全体スクロール）の受け入れ可否を確認

2. **カスタムコンポーネント開発の準備**

   - React/TypeScript の学習リソースの整理
   - Streamlit Components API の詳細調査
   - プロトタイプの実装計画

3. **外部ライブラリの調査**
   - 利用可能なライブラリの一覧作成
   - 各ライブラリの機能・制約の調査
   - 実装例の検証
