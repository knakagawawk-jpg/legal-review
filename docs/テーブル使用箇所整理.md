# ãƒ†ãƒ¼ãƒ–ãƒ«ä½¿ç”¨ç®‡æ‰€æ•´ç†ï¼ˆOfficialQuestionçµ±åˆå®Œäº†ï¼‰

## æ¦‚è¦
`ProblemMetadata`/`ProblemDetails`ã‚·ã‚¹ãƒ†ãƒ ã‚’`OfficialQuestion`ã«çµ±åˆå®Œäº†ã€‚
æ—§ã‚·ã‚¹ãƒ†ãƒ ã¯å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã€`OfficialQuestion`ãƒ†ãƒ¼ãƒ–ãƒ«ã§çµ±ä¸€ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã€‚

---

## 1. ProblemMetadata / ProblemDetails ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç®‡æ‰€

### 1.1 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆPythonï¼‰

#### `app/main.py`
- **ä½¿ç”¨ç®‡æ‰€**: è¤‡æ•°
  - `/v1/official-questions/years` - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼ˆ387-393è¡Œç›®ï¼‰
  - `/v1/official-questions/active` - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼ˆ411-444è¡Œç›®ï¼‰
  - `/v1/problems/metadata` - ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆ638-710è¡Œç›®ï¼‰
  - `/v1/problems/metadata/{metadata_id}` - ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆ712-752è¡Œç›®ï¼‰
  - `/v1/problems/metadata/{metadata_id}/details` - ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆ754-777è¡Œç›®ï¼‰
  - `/v1/reviews` - è¬›è©•ä½œæˆæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆ912-944è¡Œç›®ï¼‰

#### `app/init_db.py`
- **ä½¿ç”¨ç®‡æ‰€**: 
  - JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ï¼ˆ`import_all_json_files()`ï¼‰
  - `ProblemMetadata`ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç©ºã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ`check_needs_import()`ï¼‰
  - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆ`run_migration()`ï¼‰

#### `app/seed_official_questions.py`
- **ä½¿ç”¨ç®‡æ‰€**: 
  - `ProblemMetadata`/`ProblemDetails`ã‹ã‚‰`OfficialQuestion`ã‚’ç”Ÿæˆï¼ˆãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼‰

#### `scripts/import_all_json_to_db.py`
- **ä½¿ç”¨ç®‡æ‰€**: 
  - JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’`ProblemMetadata`/`ProblemDetails`ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼‰

#### `scripts/migrate_to_new_problem_structure.py`
- **ä½¿ç”¨ç®‡æ‰€**: 
  - å¤ã„`Problem`ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰`ProblemMetadata`/`ProblemDetails`ã¸ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

#### `scripts/verify_json_to_db_subject_storage.py`
- **ä½¿ç”¨ç®‡æ‰€**: 
  - JSONã‹ã‚‰DBã¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¤œè¨¼

#### `scripts/fix_problem_metadata_subjects.py`
- **ä½¿ç”¨ç®‡æ‰€**: 
  - `ProblemMetadata`ã®ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ä¿®æ­£

#### `scripts/import_json_to_db.py`
- **ä½¿ç”¨ç®‡æ‰€**: 
  - å˜ä¸€JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

#### `import_all_json_to_db.py`ï¼ˆãƒ«ãƒ¼ãƒˆï¼‰
- **ä½¿ç”¨ç®‡æ‰€**: 
  - `scripts/import_all_json_to_db.py`ã®ã‚³ãƒ”ãƒ¼

### 1.2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆTypeScript/Reactï¼‰

#### `web_next/types/api.ts`
- **ä½¿ç”¨ç®‡æ‰€**: 
  - `ProblemMetadata`, `ProblemMetadataWithDetails`å‹å®šç¾©

#### `web_next/app/review/page.tsx`
- **ä½¿ç”¨ç®‡æ‰€**: 
  - `ProblemMetadata`, `ProblemMetadataWithDetails`å‹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

### 1.3 ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

#### `app/schemas.py`
- **ä½¿ç”¨ç®‡æ‰€**: 
  - `ProblemMetadataResponse`
  - `ProblemDetailsResponse`
  - `ProblemMetadataWithDetailsResponse`
  - `ProblemMetadataCreate`
  - `ProblemDetailsCreate`
  - `ProblemDetailsUpdate`
  - `ProblemMetadataListResponse`

---

## 2. OfficialQuestion / ShihouGradingImpression ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç®‡æ‰€

### 2.1 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆPythonï¼‰

#### `app/main.py`
- **ä½¿ç”¨ç®‡æ‰€**: è¤‡æ•°
  - `/v1/official-questions/years` - ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆ379-394è¡Œç›®ï¼‰
  - `/v1/official-questions/active` - ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆ404-465è¡Œç›®ï¼‰
  - `/v1/reviews` - è¬›è©•ä½œæˆæ™‚ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆ895-906è¡Œç›®ï¼‰
  - `/v1/reviews/{review_id}` - è¬›è©•å–å¾—æ™‚ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆ1213-1223è¡Œç›®ï¼‰
  - `/v1/reviews/{review_id}/chat` - ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—ï¼ˆ318-323è¡Œç›®ï¼‰
  - `_get_review_chat_context_by_review_id()` - å†…éƒ¨é–¢æ•°ï¼ˆ318-323è¡Œç›®ï¼‰

#### `app/seed_official_questions.py`
- **ä½¿ç”¨ç®‡æ‰€**: 
  - `ProblemMetadata`/`ProblemDetails`ã‹ã‚‰`OfficialQuestion`/`ShihouGradingImpression`ã‚’ç”Ÿæˆ

### 2.2 ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

#### `app/schemas.py`
- **ä½¿ç”¨ç®‡æ‰€**: 
  - `OfficialQuestionYearsResponse`
  - `OfficialQuestionActiveResponse`

---

## 3. ä¸¡æ–¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç®‡æ‰€ï¼ˆæ··åœ¨ï¼‰

### 3.1 `app/main.py`
- **`/v1/official-questions/years`**:
  - ãƒ¡ã‚¤ãƒ³: `OfficialQuestion`ã‚’ä½¿ç”¨
  - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: `ProblemMetadata`ã‚’ä½¿ç”¨ï¼ˆ387-393è¡Œç›®ï¼‰

- **`/v1/official-questions/active`**:
  - ãƒ¡ã‚¤ãƒ³: `OfficialQuestion`ã‚’ä½¿ç”¨
  - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: `ProblemMetadata`/`ProblemDetails`ã‹ã‚‰`OfficialQuestion`ã‚’å‹•çš„ç”Ÿæˆï¼ˆ411-444è¡Œç›®ï¼‰

- **`/v1/reviews`**:
  - ãƒ¡ã‚¤ãƒ³: `OfficialQuestion`ã‚’ä½¿ç”¨ï¼ˆ`req.official_question_id`ï¼‰
  - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: `ProblemMetadata`/`ProblemDetails`ã‚’ä½¿ç”¨ï¼ˆ`req.problem_metadata_id`ï¼‰

### 3.2 `app/seed_official_questions.py`
- `ProblemMetadata`/`ProblemDetails`ã‚’èª­ã¿å–ã‚Šã€`OfficialQuestion`/`ShihouGradingImpression`ã‚’ç”Ÿæˆ

---

## 4. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
```
JSONãƒ•ã‚¡ã‚¤ãƒ«
  â†“
import_all_json_to_db.py
  â†“
ProblemMetadata / ProblemDetails
  â†“
seed_official_questions.pyï¼ˆæ‰‹å‹•å®Ÿè¡Œã¾ãŸã¯init_db.pyï¼‰
  â†“
OfficialQuestion / ShihouGradingImpression
  â†“
Reviewï¼ˆè¬›è©•æ©Ÿèƒ½ï¼‰
```

### çµ±åˆå¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆæƒ³å®šï¼‰
```
JSONãƒ•ã‚¡ã‚¤ãƒ«
  â†“
import_all_json_to_db.pyï¼ˆä¿®æ­£ï¼‰
  â†“
OfficialQuestion / ShihouGradingImpression
  â†“
Reviewï¼ˆè¬›è©•æ©Ÿèƒ½ï¼‰
```

---

## 5. çµ±åˆæ™‚ã«ä¿®æ­£ãŒå¿…è¦ãªç®‡æ‰€

### 5.1 å¿…é ˆä¿®æ­£

1. **`scripts/import_all_json_to_db.py`**
   - `ProblemMetadata`/`ProblemDetails`ã¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ â†’ `OfficialQuestion`/`ShihouGradingImpression`ã¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤‰æ›´

2. **`app/main.py`**
   - `/v1/problems/metadata`ç³»ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‰Šé™¤ã¾ãŸã¯`OfficialQuestion`ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´
   - `/v1/official-questions/*`ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’å‰Šé™¤
   - `/v1/reviews`ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’å‰Šé™¤

3. **`app/schemas.py`**
   - `ProblemMetadata*`ç³»ã‚¹ã‚­ãƒ¼ãƒã‚’å‰Šé™¤ã¾ãŸã¯éæ¨å¥¨åŒ–

4. **`app/init_db.py`**
   - `ProblemMetadata`/`ProblemDetails`ã¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ã‚’å‰Šé™¤
   - `OfficialQuestion`/`ShihouGradingImpression`ã¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ã«å¤‰æ›´

### 5.2 å‰Šé™¤ã¾ãŸã¯éæ¨å¥¨åŒ–

1. **`app/seed_official_questions.py`**
   - çµ±åˆå¾Œã¯ä¸è¦ï¼ˆå‰Šé™¤ã¾ãŸã¯éæ¨å¥¨åŒ–ï¼‰

2. **`scripts/migrate_to_new_problem_structure.py`**
   - çµ±åˆå¾Œã¯ä¸è¦ï¼ˆå‰Šé™¤ã¾ãŸã¯éæ¨å¥¨åŒ–ï¼‰

3. **`scripts/verify_json_to_db_subject_storage.py`**
   - `OfficialQuestion`ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´

4. **`scripts/fix_problem_metadata_subjects.py`**
   - çµ±åˆå¾Œã¯ä¸è¦ï¼ˆå‰Šé™¤ã¾ãŸã¯éæ¨å¥¨åŒ–ï¼‰

5. **`scripts/import_json_to_db.py`**
   - `OfficialQuestion`ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´

6. **`import_all_json_to_db.py`ï¼ˆãƒ«ãƒ¼ãƒˆï¼‰**
   - å‰Šé™¤ï¼ˆ`scripts/`ç‰ˆã«çµ±ä¸€ï¼‰

### 5.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

1. **`web_next/types/api.ts`**
   - `ProblemMetadata*`å‹ã‚’å‰Šé™¤ã¾ãŸã¯éæ¨å¥¨åŒ–

2. **`web_next/app/review/page.tsx`**
   - `ProblemMetadata*`å‹ã®ä½¿ç”¨ã‚’å‰Šé™¤

---

## 6. æ³¨æ„äº‹é …

### 6.1 ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
- æ—¢å­˜ã®`ProblemMetadata`/`ProblemDetails`ãƒ‡ãƒ¼ã‚¿ã‚’`OfficialQuestion`/`ShihouGradingImpression`ã«ç§»è¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- `seed_official_questions.py`ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‚è€ƒã«ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ

### 6.2 å¾Œæ–¹äº’æ›æ€§
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒ`/v1/problems/metadata`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ç§»è¡ŒæœŸé–“ä¸­ã¯äº’æ›æ€§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç¶­æŒã™ã‚‹å¿…è¦ãŒã‚ã‚‹å¯èƒ½æ€§

### 6.3 è¨­å•ç•ªå·ã®æ‰±ã„
- `ProblemDetails`ã¯`question_number`ã§è¤‡æ•°è¨­å•ã‚’ç®¡ç†å¯èƒ½
- `OfficialQuestion`ã¯å˜ä¸€å•é¡Œæ–‡ã®ã¿ï¼ˆè¨­å•ç•ªå·ãªã—ï¼‰
- è¤‡æ•°è¨­å•ãŒå¿…è¦ãªå ´åˆã¯è¨­è¨ˆè¦‹ç›´ã—ãŒå¿…è¦

---

## 7. çµ±åˆå®Œäº†çŠ¶æ³

### âœ… å®Œäº†ã—ãŸä½œæ¥­

1. **ã‚³ã‚¢æ©Ÿèƒ½ã®çµ±åˆ**
   - âœ… `scripts/import_all_json_to_db.py`ã‚’`OfficialQuestion`ãƒ™ãƒ¼ã‚¹ã«ä¿®æ­£
   - âœ… `app/main.py`ã®`/v1/official-questions/*`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‰Šé™¤
   - âœ… `app/main.py`ã®`/v1/reviews`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‰Šé™¤
   - âœ… `/v1/problems/metadata`ç³»ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å‰Šé™¤ï¼ˆæ—¢ã«å‰Šé™¤æ¸ˆã¿ï¼‰

2. **ã‚¹ã‚­ãƒ¼ãƒãƒ»ãƒ¢ãƒ‡ãƒ«ã®æ•´ç†**
   - âœ… `app/schemas.py`ã‹ã‚‰`ProblemMetadata*`ç³»ã‚¹ã‚­ãƒ¼ãƒã‚’å‰Šé™¤
   - âœ… `app/models.py`ã‹ã‚‰`ProblemMetadata`/`ProblemDetails`ãƒ¢ãƒ‡ãƒ«ã‚’å‰Šé™¤
   - âœ… `app/models.py`ã®`Submission`ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰`problem_metadata_id`/`problem_details_id`ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤
   - âœ… `web_next/types/api.ts`ã‹ã‚‰`ProblemMetadata*`å‹ã‚’å‰Šé™¤
   - âœ… `web_next/app/review/page.tsx`ã‹ã‚‰`ProblemMetadata*`å‹ã®ä½¿ç”¨ã‚’å‰Šé™¤

3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
   - âœ… `app/migrate_remove_old_problem_tables.py`ã‚’ä½œæˆ
   - âœ… `app/entrypoint.sh`ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ 
   - âœ… `problem_metadata`/`problem_details`ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ã®æº–å‚™å®Œäº†
   - âœ… `submissions`ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰`problem_metadata_id`/`problem_details_id`ã‚«ãƒ©ãƒ å‰Šé™¤ã®æº–å‚™å®Œäº†

4. **æ¡ç‚¹å®Ÿæ„Ÿã®çµ±åˆ**
   - âœ… `OfficialQuestion`ãƒ†ãƒ¼ãƒ–ãƒ«ã«`grading_impression_text`ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ï¼ˆNULLå¯ï¼‰
   - âœ… `ShihouGradingImpression`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
   - âœ… å¸æ³•è©¦é¨“ã®ã¿æ¡ç‚¹å®Ÿæ„Ÿã‚’æŒã¤è¨­è¨ˆã‚’å®Ÿç¾

### ğŸ“ æ³¨æ„äº‹é …

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ`migrate_remove_old_problem_tables.py`ï¼‰ã¯æ¬¡å›ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™
- SQLiteã®å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯`ALTER TABLE DROP COLUMN`ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€ãƒ¢ãƒ‡ãƒ«å®šç¾©ã‹ã‚‰ã¯æ—¢ã«å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ãŸã‚å•é¡Œã‚ã‚Šã¾ã›ã‚“
