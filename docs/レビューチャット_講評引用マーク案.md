# レビューチャット：講評クリック時の引用マーク案

## 背景

- 講評タブのカードや答案タブの段落をクリックすると、その内容がチャット入力欄に「」でくくって挿入される。
- LLM はそのテキストが**自分が付けた講評の一部**だと分からず、会話がずれることがある。
- **マーク**で「講評由来の引用」であることを示し、**プロンプト**で経緯を説明して LLM に理解させたい。

---

## 1. マーク案（講評クリック時のみ）

挿入するテキストの**前に**、講評由来であることを示すプレフィックスを付ける。

| 案 | 挿入例 | 特徴 |
|----|--------|------|
| **A. 短いタグ** | `[講評引用] 「〇〇についてもう少し詳しく」（§3）` | 短く、パースしやすい。 |
| **B. 説明文** | `【講評の該当箇所】「〇〇について…」（§3）` | 人間にも意味が分かりやすい。 |
| **C. 定型句** | `以下はあなたが付けた講評の該当箇所です。「〇〇について…」（§3）` | LLM に最も伝わりやすいが、入力が長くなる。 |
| **D. 括りだけ変更** | `《講評》「〇〇について…」（§3）《／講評》` | 引用範囲が明確。やや冗長。 |

**採用**: **A**（`[講評引用]`）で実装済み。プロンプトで「このチャットの位置づけ」と「[講評引用]の扱い」を追加済み。

---

## 2. 答案クリック時の扱い（オプション）

答案タブの段落をクリックしたときは「ユーザー答案の該当箇所」なので、講評とは別扱いにすると LLM が混乱しにくい。

- **現状のまま**: 答案クリック時も「」のみ（講評クリック時だけマークを付ける）。
- **区別する**: 答案クリック時は `【答案の該当箇所】「…」（§N）` のように別プレフィックスを付ける。  
  → 「講評の引用」と「答案の引用」をプロンプトで両方説明できる。

---

## 3. プロンプト追加案（review_chat_system.txt）

以下の段落を、システムプロンプトの「与えられた情報を根拠に…」の前か、その直後の箇条書きのあとに追加する。

```
- ユーザーの質問に「【講評の該当箇所】」または「[講評引用]」で始まる引用が含まれる場合、それはあなたがこの答案に対して行った講評結果の一部を、ユーザーが画面上の講評タブでクリックして入力欄に挿入したものです。その引用はあなた自身の講評の抜粋なので、その内容を前提に質問や深掘りに答えてください。
```

- マークに **A** を採用する場合は「[講評引用]」、**B** の場合は「【講評の該当箇所】」に合わせる。
- **C** の場合は「以下はあなたが付けた講評の該当箇所です。」で始まる場合、と書いてもよい。

---

## 4. 実装の変更点

1. **フロント（review-result-view.tsx）**
   - 講評由来の挿入（FeedbackCard・改善点カード・重要ポイント等のクリック）のときだけ、`handleInsertToChat` に渡す前にプレフィックスを付ける。
   - 例: `handleInsertToChat("[講評引用] 「" + text + "」")` または定数 `REVIEW_QUOTE_PREFIX = "【講評の該当箇所】 "` を先頭に付ける。
   - 答案段落の `onParagraphCopyClick` / 段落クリックでは**プレフィックスを付けない**（現状どおり「」のみ）、または「【答案の該当箇所】」を付ける（オプション）。

2. **プロンプト（prompts/main/review_chat_system.txt）**
   - 上記の 1 文を追加する。

3. **UI 説明文（任意）**
   - 「答案・講評タブの段落やカードをクリックすると…」の説明に、「講評をクリックした部分は【講評の該当箇所】として入力され、AI が自分の講評と認識して答えます」などと一文足してもよい。

---

## 5. まとめ

- **講評クリック時**: マーク（推奨 **【講評の該当箇所】** または **[講評引用]**）＋ システムプロンプトで「あなたの講評の抜粋なのでそれを前提に答えよ」と明示する。
- **答案クリック時**: 現状どおり「」のみ、または「【答案の該当箇所】」で区別する（任意）。
- これで「自分が付けた講評のここについて聞かれている」と LLM が理解し、会話のずれを減らせる。
